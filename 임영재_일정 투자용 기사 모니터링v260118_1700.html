<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íˆ¬ì í†µí•© ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (v3.5_Full_Edit)</title>
    <style>
        :root { --primary: #004085; --naver: #03cf5d; --google: #4285f4; --bg: #f4f7fa; --scrap: #ffc107; --danger: #e63946; --custom: #6f42c1; }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 12px; height: 100vh; overflow: hidden; }
        
        .dashboard-grid { display: grid; grid-template-columns: 320px 340px 340px 1fr; grid-template-rows: 1fr 220px; gap: 12px; height: calc(100vh - 24px); }
        .column { display: flex; flex-direction: column; gap: 12px; height: 100%; min-height: 0; }
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; height: 100%; min-height: 0; }
        .title { font-size: 1.05rem; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

        .sort-select { padding: 2px 4px; font-size: 0.75rem; border-radius: 4px; border: 1px solid #ddd; outline: none; cursor: pointer; background: #fafafa; }

        .mode-switch-container { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; font-weight: bold; color: #555; background: #f8f9fa; padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--custom); }
        input:checked + .slider:before { transform: translateX(16px); }

        .date-presets { display: flex; gap: 4px; margin-bottom: 8px; }
        .btn-preset { flex: 1; padding: 5px; font-size: 0.7rem; border: 2px solid #999; background: #f8f9fa; border-radius: 4px; cursor: pointer; }
        .date-filter { display: flex; gap: 4px; margin-bottom: 10px; background: #333; padding: 8px; border-radius: 8px; align-items: center; color: white; }
        .date-filter input { flex: 1; padding: 5px; border: none; border-radius: 4px; font-size: 0.75rem; text-align: center; outline: none; }
        
        .keyword-management { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; padding: 10px; background: #f1f3f5; border-radius: 8px; }
        .keyword-row { display: flex; gap: 4px; }
        .keyword-row input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; }
        .btn-admin { background: #6c757d; color: white; border: none; border-radius: 4px; padding: 5px 8px; cursor: pointer; font-size: 0.65rem; }

        .filter-group { flex-grow: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 4px; }
        .keyword-item { display: flex; align-items: center; gap: 4px; width: 100%; }
        .filter-btn { flex: 1; padding: 9px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; font-size: 0.8rem; text-align: left; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }
        .filter-btn.is-custom { border-left: 4px solid var(--custom); }
        .filter-btn.is-custom.active { background: var(--custom); border-color: var(--custom); }
        
        .kw-actions { display: flex; gap: 2px; }
        .btn-kw-tool { padding: 4px 6px; font-size: 0.65rem; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .btn-kw-tool:hover { background: #eee; }

        .btn-tool { padding: 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }

        .query-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
        #currentQueryInput { width: 100%; padding: 10px; border: 2px solid var(--primary); border-radius: 6px; font-size: 0.85rem; margin-bottom: 8px; outline: none; background: #fff; }

        .local-search { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.8rem; background: #fafafa; outline: none; border-left: 4px solid #007bff; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding-right: 5px; position: relative; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; padding-top: 50px; font-weight: bold; color: var(--primary); z-index: 10; }

        .item { padding: 12px 10px; border-bottom: 1px solid #f1f1f1; cursor: pointer; border-radius: 6px; position: relative; transition: 0.2s; }
        .item:hover { background-color: #f0f4f8; }
        .item.selected { background-color: #e7f1ff; border-left: 4px solid var(--primary); }
        .item-title { font-size: 0.88rem; font-weight: bold; line-height: 1.45; margin-bottom: 5px; color: #222; padding-right: 65px; word-break: break-all; }
        
        .hl { color: var(--danger); background: #fff0f0; padding: 0 1px; border-radius: 2px; text-decoration: underline; font-weight: 800; }
        .press-badge { color: #d32f2f; font-weight: 600; background: #fff5f5; padding: 1px 4px; border-radius: 3px; border: 1px solid #ffebeb; font-size: 0.7rem; }
        
        .item-actions { position: absolute; top: 10px; right: 8px; display: flex; gap: 5px; z-index: 100; }
        .btn-action-small { background: #fff; border: 1px solid #ddd; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.85rem; }
        .btn-scrap.active { color: var(--scrap); border-color: var(--scrap); background: #fffdf0; }

        .preview-container { flex-grow: 1; position: relative; background: #fff; overflow: hidden; border: 1px solid #ddd; border-radius: 0 0 12px 12px; }
        #previewFrame { width: 133.33%; height: 133.33%; border: none; transform: scale(0.75); transform-origin: 0 0; position: absolute; top: 0; left: 0; }

        .scrap-area { grid-column: span 4; background: #fff; border-radius: 12px; padding: 15px; border-top: 4px solid var(--scrap); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .scrap-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; flex-grow: 1; }
        .scrap-card { min-width: 320px; max-width: 320px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 12px; position: relative; }
        .scrap-card-title { font-size: 0.82rem; font-weight: bold; line-height: 1.35; margin-bottom: 5px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .scrap-memo { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.75rem; background: #fff; outline: none; margin-top: 5px; }
    </style>
</head>
<body>

<div class="dashboard-grid">
    <div class="column">
        <div class="card">
            <div class="title">ğŸ¯ íˆ¬ì ëª¨ë‹ˆí„°ë§
                <div class="mode-switch-container"><span>ì»¤ìŠ¤í…€</span>
                    <label class="switch"><input type="checkbox" id="customModeToggle" onchange="setCustomView(this.checked)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="date-presets">
                <button class="btn-preset" onclick="setDatePreset(0)">ì˜¤ëŠ˜</button>
                <button class="btn-preset" onclick="setDatePreset(2)">3ì¼</button>
                <button class="btn-preset" onclick="setDatePreset(6)">1ì£¼ì¼</button>
            </div>
            <div class="date-filter">
                <input type="date" id="startDate"><span>~</span><input type="date" id="endDate">
                <button onclick="fetchAll()" class="btn-search" style="padding:4px 10px; cursor:pointer;">ğŸ”</button>
            </div>
            <div class="keyword-management">
                <div class="keyword-row"><input type="text" id="newKeywordInput" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€..."><button onclick="addKeyword()" class="btn-tool" style="background:var(--primary); color:white;">ì¶”ê°€</button></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 4px;">
                    <button class="btn-admin" onclick="exportKeywords()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn-admin" onclick="importKeywords()">ğŸ“¤ ê°€ì ¸ì˜¤ê¸°</button>
                    <button class="btn-admin" style="background:var(--danger)" onclick="resetToDefault()">ğŸ”„ ë¦¬ì…‹</button>
                </div>
            </div>
            <div class="filter-group" id="keywordListContainer"></div>
            <div class="query-section">
                <input type="text" id="currentQueryInput" placeholder="ì¿¼ë¦¬ ì§ì ‘ ìˆ˜ì •">
                <button onclick="fetchAll()" style="width:100%; padding:12px; background:#e63946; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ìƒˆ ê²°ê³¼ íƒìƒ‰</button>
            </div>
        </div>
    </div>

    <!-- ë„¤ì´ë²„ ì»¬ëŸ¼ -->
    <div class="column">
        <div class="card">
            <div class="title" style="color:var(--naver)">
                ğŸŸ¢ ë„¤ì´ë²„ ë‰´ìŠ¤
                <select id="naverSortSelect" class="sort-select" onchange="fetchAll()">
                    <option value="sim">ê´€ë ¨ë„ìˆœ</option>
                    <option value="desc" selected>ìµœì‹ ìˆœ</option>
                    <option value="asc">ì˜¤ë˜ëœìˆœ</option>
                </select>
            </div>
            <input type="text" class="local-search" data-target="naverList" placeholder="ê²°ê³¼ ë‚´ ê²€ìƒ‰..." onkeyup="reSearchList(this)">
            <div class="scroll-area" id="naverArea">
                <div class="loading-overlay" id="naverLoading">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
                <div id="naverList"></div>
            </div>
        </div>
    </div>
    <!-- êµ¬ê¸€ ì»¬ëŸ¼ -->
    <div class="column">
        <div class="card">
            <div class="title" style="color:var(--google)">
                ğŸ”µ êµ¬ê¸€ ë‰´ìŠ¤
                <select id="googleSortSelect" class="sort-select" onchange="fetchAll()">
                    <option value="sim">ê´€ë ¨ë„ìˆœ</option>
                    <option value="desc" selected>ìµœì‹ ìˆœ</option>
                    <option value="asc">ì˜¤ë˜ëœìˆœ</option>
                </select>
            </div>
            <input type="text" class="local-search" data-target="googleList" placeholder="ê²°ê³¼ ë‚´ ê²€ìƒ‰..." onkeyup="reSearchList(this)">
            <div class="scroll-area" id="googleArea">
                <div class="loading-overlay" id="googleLoading">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
                <div id="googleList"></div>
            </div>
        </div>
    </div>
    <div class="column">
        <div class="card" style="padding:0; border:none;">
            <div style="padding:10px 15px; background:#343a40; color:white; display:flex; justify-content:space-between; align-items:center; border-radius:12px 12px 0 0;">
                <span id="previewTitle" style="font-size:0.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:75%;">ê¸°ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                <button onclick="window.open(document.getElementById('previewFrame').src)" style="font-size:0.7rem; background:#555; color:white; border:none; padding:2px 8px; cursor:pointer;">ìƒˆì°½ì—´ê¸°</button>
            </div>
            <div class="preview-container"><iframe id="previewFrame" src="about:blank"></iframe></div>
        </div>
    </div>
    <div class="scrap-area">
        <div class="title" style="border:none; margin-bottom:5px;"><span>â­ ìŠ¤í¬ë© ë³´ê´€í•¨</span>
            <div><button onclick="copyScrapReport()" style="background:var(--primary); color:#fff; border:none; padding:5px 15px; border-radius:4px; cursor:pointer; font-size:0.8rem;">ğŸ“‹ ë³´ê³ ì„œ ë³µì‚¬</button><button onclick="clearScrap()" style="margin-left:5px; padding:5px 10px; cursor:pointer; font-size:0.8rem;">ğŸ—‘ï¸ ë¹„ìš°ê¸°</button></div>
        </div>
        <div class="scrap-list" id="scrapList"></div>
    </div>
</div>

<script>
    const OID_MAP = {'001':'ì—°í•©ë‰´ìŠ¤','422':'ì—°í•©ë‰´ìŠ¤TV','003':'ë‚´ì¼ì‹ ë¬¸','005':'êµ­ë¯¼ì¼ë³´','006':'ë¯¸ë””ì–´ì˜¤ëŠ˜','020':'ë™ì•„ì¼ë³´','021':'ë¬¸í™”ì¼ë³´','022':'ì„¸ê³„ì¼ë³´','023':'ì¡°ì„ ì¼ë³´','025':'ì¤‘ì•™ì¼ë³´','028':'í•œê²¨ë ˆ','032':'ê²½í–¥ì‹ ë¬¸','081':'ì„œìš¸ì‹ ë¬¸','088':'ë§¤ì¼ì‹ ë¬¸','009':'ë§¤ì¼ê²½ì œ','011':'ì„œìš¸ê²½ì œ','014':'íŒŒì´ë‚¸ì…œë‰´ìŠ¤','015':'í•œêµ­ê²½ì œ','016':'í—¤ëŸ´ë“œê²½ì œ','018':'ì´ë°ì¼ë¦¬','277':'ì•„ì‹œì•„ê²½ì œ','366':'ì¡°ì„ ë¹„ì¦ˆ','052':'YTN','055':'SBS','056':'KBS','057':'YTN','214':'MBC','437':'JTBC','448':'TVì¡°ì„ ','449':'ì±„ë„A','030':'ì „ìì‹ ë¬¸','031':'ì•„ì´ë‰´ìŠ¤24','092':'ZDNet Korea','138':'ë””ì§€í„¸ë°ì¼ë¦¬','140':'CIO Korea','293':'ë¸”ë¡œí„°','119':'ë°ì¼ë¦¬ì•ˆ','037':'ì£¼ê°„ë™ì•„','308':'ì½”ë©”ë””ë‹·ì»´','346':'í—¬ìŠ¤ì¡°ì„ ','421':'ë‰´ìŠ¤1','469':'í•œêµ­ì¼ë³´','417':'ë‰´ìŠ¤í•Œ','447':'ë‰´ìŠ¤ì›¨ì´','353':'ì¤‘ì•™SUNDAY'};
    const DOMAIN_ALIAS = {'hankyung':'í•œêµ­ê²½ì œ','mk':'ë§¤ì¼ê²½ì œ','sedaily':'ì„œìš¸ê²½ì œ','edaily':'ì´ë°ì¼ë¦¬','fnnews':'íŒŒì´ë‚¸ì…œë‰´ìŠ¤','asiae':'ì•„ì‹œì•„ê²½ì œ','biz.chosun':'ì¡°ì„ ë¹„ì¦ˆ','heraldcorp':'í—¤ëŸ´ë“œê²½ì œ','mt':'ë¨¸ë‹ˆíˆ¬ë°ì´','chosun':'ì¡°ì„ ì¼ë³´','donga':'ë™ì•„ì¼ë³´','hani':'í•œê²¨ë ˆ','khan':'ê²½í–¥ì‹ ë¬¸','joongang':'ì¤‘ì•™ì¼ë³´','seoul':'ì„œìš¸ì‹ ë¬¸','kukinews':'êµ­ë¯¼ì¼ë³´','segye':'ì„¸ê³„ì¼ë³´','munhwa':'ë¬¸í™”ì¼ë³´','news1':'ë‰´ìŠ¤1','hankookilbo':'í•œêµ­ì¼ë³´','ytn':'YTN','sbs':'SBS','kbs':'KBS','imbc':'MBC','jtbc':'JTBC','tvchosun':'TVì¡°ì„ ','ichannela':'ì±„ë„A','zdnet':'ZDNet Korea','ddaily':'ë””ì§€í„¸ë°ì¼ë¦¬','bloter':'ë¸”ë¡œí„°','cio':'CIO Korea','etnews':'ì „ìì‹ ë¬¸','dailian':'ë°ì¼ë¦¬ì•ˆ','ohmynews':'ì˜¤ë§ˆì´ë‰´ìŠ¤','pressian':'í”„ë ˆì‹œì•ˆ','mediatoday':'ë¯¸ë””ì–´ì˜¤ëŠ˜','sisain':'ì‹œì‚¬IN','newstapa':'ë‰´ìŠ¤íƒ€íŒŒ'};


    const FIXED_HIGHLIGHTS = ["1ì¼","2ì¼","3ì¼","4ì¼","5ì¼","6ì¼","7ì¼","8ì¼","9ì¼","10ì¼","11ì¼","12ì¼","13ì¼","14ì¼","15ì¼","16ì¼","17ì¼","18ì¼","19ì¼","20ì¼","21ì¼","22ì¼","23ì¼","24ì¼","25ì¼","26ì¼","27ì¼","28ì¼","29ì¼","30ì¼","31ì¼","ì›”ì´ˆ","ì›” ì´ˆ","ì›”ì¤‘","ì›”ë§","ì›” ë§","ì´ë‹¬","ì´ë‹¬ ì´ˆ","ì´ë‹¬ì´ˆ","ì´ë‹¬ ì¤‘","ì´ë‹¬ ì¤‘ìˆœ","ì´ë‹¬ì¤‘ìˆœ","ì´ë‹¬ ë§","ì´ë‹¬ë§","ë‹¤ìŒë‹¬","ë‹¤ìŒ ë‹¬","ë‚´ë‹¬","ë‚´ ë‹¬","1ë¶„ê¸°","2ë¶„ê¸°","3ë¶„ê¸°","4ë¶„ê¸°","ë¶„ê¸°ë§","ë¶„ê¸° ë§","ìƒë°˜ê¸°","í•˜ë°˜ê¸°","ì—°ë§","ì—°ë‚´","ë‚´ë…„","ìµœì´ˆ","ìµœëŒ€","ìµœê³ ","ìˆ˜ì£¼","ê³„ì•½","M&A","ì¸ìˆ˜","í•©ë³‘","ë…ì ","ê³µê¸‰","ìƒì¥","ìœ ìƒì¦ì","íš¡ë ¹","ë°°ì„","íŠ¹í—ˆ","ì„¸ê³„ ìµœì´ˆ","êµ­ë‚´ ìµœì´ˆ","ì‚¬ìƒ ìµœëŒ€","ìµœëŒ€ í¥í–‰","1ìœ„","ì ìœ ìœ¨","ë…ë³´ì ","ì›ì²œ ê¸°ìˆ ","ëŒ€ê·œëª¨ ìˆ˜ì£¼","ëŒ€ê·œëª¨ ê³µê¸‰","ê¸€ë¡œë²Œ ì œíœ´","ê¸€ë¡œë²Œ ê³„ì•½","ê¸°ìˆ  ìˆ˜ì¶œ","ê¸°ìˆ  ì´ì „","í•´ì™¸ ì§„ì¶œ","ìˆ˜ì¶œ ë³¸ê²©í™”","ì—…ë¬´ í˜‘ì•½","MOU","ì˜¤ì¼ë¨¸ë‹ˆ","ê·œì œ ê°œí˜","ê·œì œ íì§€","ì •ë¶€ ì§€ì›","ì •ë¶€ ì‹ ì‚¬ì—…","êµ­ì±… ê³¼ì œ","ì„¸ì œ í˜œíƒ","ì˜ˆíƒ€ í†µê³¼","ë²•ì•ˆ í†µê³¼","K-ë‰´ë”œ","ëŒ€ê·œëª¨ íˆ¬ì","ìˆ˜ì‹­ ì¡° íˆ¬ì","ê³µì¥ ì¦ì„¤","ì„¤ë¹„ íˆ¬ì","ìƒì‚° ë¼ì¸ í™•ëŒ€","êµ­ì‚°í™” ì„±ê³µ","ì§€ë¶„ íˆ¬ì","ìê¸ˆ ì¡°ë‹¬","ì–‘ì‚°","ìì‚¬ì£¼ ë§¤ì…","ìì‚¬ì£¼ ì†Œê°","ë°°ë‹¹ í™•ëŒ€","ë¬´ìƒ ì¦ì","ì£¼ì£¼ ì¹œí™”","ë°¸ë¥˜ì—…","ì €PBR","ì•¡ë©´ ë¶„í• ","ì¬ìƒì¥","ê²½ì˜ê¶Œ ë¶„ìŸ","ì§€ë¶„ ë§¤ê°","ë§¤ê° ëŒ€ê¸ˆ","ìíšŒì‚¬ ìƒì¥","IPO","ì¶œì‹œ","ë°œí‘œ","ì»´ë°±","ê³µê°œ","ë°ë·”","ê°œë´‰","ì‹ ì‘","í‹°ì €","ë¼ì¸ì—…","ëŒ€ì£¼ì£¼ ë§¤ë„","ê²½ì˜ì§„ ë§¤ë„","ê³„ì•½ í•´ì§€","ë§¤ê° ì² íšŒ","ë¬´ìƒê°ì","ìì‚¬ì£¼ ë§¤ê°","ê±°ë˜ ì •ì§€","ì†Œì†¡","ì‹ ìš© ë“±ê¸‰ í•˜ë½"];
    
    const DEFAULT_KEYWORDS = [
        { label: "1. ì›”ì´ˆ/ìƒìˆœ (1~20ì¼)", query: "1ì¼ | 2ì¼ | 3ì¼ | 4ì¼ | 5ì¼ | 6ì¼ | 7ì¼ | 8ì¼ | 9ì¼ | 10ì¼ | 11ì¼ | 12ì¼ | 13ì¼ | 14ì¼ | 15ì¼ | 16ì¼ | 17ì¼ | 18ì¼ | 19ì¼ | 20ì¼ | ì›”ì´ˆ | ì›” ì´ˆ | ì´ë‹¬ ì´ˆ | ì´ë‹¬ì´ˆ | ì›”ì¤‘" },
        { label: "2. ì›”ë§/í•˜ìˆœ (21~31ì¼)", query: "21ì¼ | 22ì¼ | 23ì¼ | 24ì¼ | 25ì¼ | 26ì¼ | 27ì¼ | 28ì¼ | 29ì¼ | 30ì¼ | 31ì¼ | ì´ë‹¬ ë§ | ì´ë‹¬ë§ | ì›” ë§ | ì›”ë§ | ì´ë‹¬ ì¤‘ìˆœ | ì´ë‹¬ì¤‘ìˆœ | ì´ë‹¬ ì¤‘ | ë‹¤ìŒë‹¬ | ë‹¤ìŒ ë‹¬ | ë‚´ë‹¬ | ë‚´ ë‹¬" },
        { label: "3. ë¶„ê¸°/ì—°ê°„", query: "1ë¶„ê¸° | 2ë¶„ê¸° | 3ë¶„ê¸° | 4ë¶„ê¸° | ë¶„ê¸°ë§ | ë¶„ê¸° ë§ | ìƒë°˜ê¸° | í•˜ë°˜ê¸° | ì—°ë§ | ì—°ë‚´ | ë‚´ë…„" },
        { label: "4. ì‹œì¥ì„ ì /ìµœì´ˆ/ìµœê³ ", query: "êµ­ë‚´ ìµœì´ˆ | ì„¸ê³„ ìµœì´ˆ | ì‚¬ìƒ ìµœëŒ€ | ìµœëŒ€ í¥í–‰ | ì„¸ê³„ 1ìœ„ | ë¯¸êµ­ 1ìœ„ | ì¤‘êµ­ 1ìœ„ | ì¼ë³¸ 1ìœ„ | ìœ ëŸ½ 1ìœ„ | ì•„ë§ˆì¡´ 1ìœ„ | í‹°ëª° 1ìœ„ | íƒ€ì˜¤ë°”ì˜¤ 1ìœ„ | ì§•ë™ë‹·ì»´ 1ìœ„ | ì•Œë¦¬ 1ìœ„ | êµ¬ê¸€ìŠ¤í† ì–´ 1ìœ„ | ì• í”ŒìŠ¤í† ì–´ 1ìœ„ | ì ìœ ìœ¨ 1ìœ„ | ë…ì  ê³µê¸‰ | ë…ë³´ì  | ì›ì²œ ê¸°ìˆ " },
        { label: "5. ìˆ˜ì£¼/ê³„ì•½/ê¸€ë¡œë²Œì§„ì¶œ", query: "ê³µê¸‰ ê³„ì•½ | ëŒ€ê·œëª¨ ê³µê¸‰ | ëŒ€ê·œëª¨ ìˆ˜ì£¼ | ìƒìš©í™” ì¶”ì§„ | ìƒìš©í™” ì„ë°• | íŠ¹í—ˆ í™•ë³´ | íŠ¹í—ˆ ìƒìš©í™” | íŠ¹í—ˆ ì·¨ë“ | ê¸€ë¡œë²Œ ì œíœ´ | ì‚¬ì—… ì§„ì¶œ | ê¸°ìˆ  ìˆ˜ì¶œ | ê¸°ìˆ  ì´ì „ | ê¸€ë¡œë²Œ ê³„ì•½ ì²´ê²° | ì˜¤ì¼ë¨¸ë‹ˆ | ì—…ë¬´ í˜‘ì•½ | MOU ì²´ê²° | í•´ì™¸ ì§„ì¶œ | ìˆ˜ì¶œ ë³¸ê²©í™”" },
        { label: "6. ì •ë¶€ì •ì±…/ê·œì œê°œí˜", query: "ê·œì œ ê°œí˜ | ê·œì œ íì§€ | ë°˜ì‚¬ ìˆ˜í˜œ | ì •ë¶€ ì‹ ì‚¬ì—… | ì •ë¶€ ì§€ì› | êµ­ì±… ê³¼ì œ | ì„¸ì œ í˜œíƒ | ì˜ˆíƒ€ í†µê³¼ | ë²•ì•ˆ í†µê³¼ | K-ë‰´ë”œ" },
        { label: "7. ëŒ€ê·œëª¨ íˆ¬ì/ì„±ê³µ", query: "ìˆ˜ì‹­ ì¡° íˆ¬ì | ì‹œì„¤ ìê¸ˆ | ê³µì¥ ì¦ì„¤ | ì„¤ë¹„ íˆ¬ì | ìƒì‚° ë¼ì¸ í™•ëŒ€ | êµ­ì‚°í™” ì„±ê³µ | ì§€ë¶„ íˆ¬ì | ìê¸ˆ ì¡°ë‹¬ | ì–‘ì‚° ì‹œì‘" },
        { label: "8. ì£¼ì£¼í™˜ì›/ë°¸ë¥˜ì—…", query: "ìì‚¬ì£¼ ë§¤ì… | ìì‚¬ì£¼ ì†Œê° | ë°°ë‹¹ í™•ëŒ€ | ë¬´ìƒ ì¦ì | ì£¼ì£¼ ì¹œí™” | ë°¸ë¥˜ì—… | ì €PBR | ì•¡ë©´ ë¶„í•  | ì¬ìƒì¥" },
        { label: "9. M&A/ì§€ë°°êµ¬ì¡°", query: "ì¸ìˆ˜ í•©ë³‘ | M&A ì¶”ì§„ | ë§¤ê° ëŒ€ê¸ˆ | ì§€ë¶„ ë§¤ê° | ê²½ì˜ê¶Œ ë¶„ìŸ | ìíšŒì‚¬ ìƒì¥ | IPO ëŒ€ì–´ | ì§€ë°°êµ¬ì¡° ê°œì„ " },
        { label: "10. ì¶œì‹œ/ë°œí‘œ (ì´ë²¤íŠ¸)", query: "ì¶œì‹œ | ë°œí‘œ | ì»´ë°± | ê³µê°œ | ë°ë·” | ê°œë´‰ | ì‹ ì‘ | í‹°ì € ê³µê°œ | ë² ì¼ ë²—ë‹¤ | ë¼ì¸ì—…" },
        { label: "11. íˆ¬ì ìœ„í—˜ (ì•…ì¬)", query: "ê²½ì˜ì§„ ì£¼ì‹ ë§¤ë„ | ê²½ì˜ì§„ ì§€ë¶„ ë§¤ë„ | ëŒ€ì£¼ì£¼ ë§¤ë„ | ë§¤ê° ì² íšŒ | ê³„ì•½ í•´ì§€ | ëŒ€ê·œëª¨ ìœ ìƒì¦ì | ì£¼ì£¼ë°°ì • ìœ ìƒì¦ì | ìœ ì¦ | ë¬´ìƒê°ì | ìì‚¬ì£¼ ë§¤ê° | ê±°ë˜ ì •ì§€ | íš¡ë ¹ | ë°°ì„ | ì†Œì†¡ ì œê¸° | ì‹ ìš© ë“±ê¸‰ í•˜ë½" }
    ];

    const PROXY = "https://corsproxy.io/?";
    const NAVER_ID = 'psW8xkUHR2KH4qPK9eBH', NAVER_SECRET = '_8eXzLfqva';

    let showCustom = localStorage.getItem('showCustom') === 'true';
    let baseKeywords = JSON.parse(localStorage.getItem('base_keywords_v3')) || [...DEFAULT_KEYWORDS];
    let userKeywords = JSON.parse(localStorage.getItem('user_keywords_v3')) || [];
    let scraps = JSON.parse(localStorage.getItem('invest_scraps_v3')) || [];
    let activeIdx = 0, isActiveUserItem = false;
    window.articleCache = {};

    function setCustomView(enabled) { showCustom = enabled; localStorage.setItem('showCustom', enabled); renderKeywords(); }

    function renderKeywords() {
        const container = document.getElementById('keywordListContainer');
        
        // ë²„íŠ¼ HTMLì„ ìƒì„±í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        const getKwdHtml = (k, idx, isUser) => {
            const isActive = (isUser === isActiveUserItem && idx === activeIdx);
            return `
            <div class="keyword-item">
                <button class="filter-btn ${isUser ? 'is-custom' : ''} ${isActive ? 'active' : ''}" onclick="selectKeyword(${idx}, ${isUser})">
                    ${k.label}
                </button>
                ${showCustom ? `
                <div class="kw-actions">
                    <button class="btn-kw-tool" title="í¸ì§‘" onclick="editKeyword(${idx}, ${isUser})">âœï¸</button>
                    <button class="btn-kw-tool" title="ì‚­ì œ" onclick="deleteKeyword(${idx}, ${isUser})">âŒ</button>
                </div>` : ''}
            </div>`;
        };

        // ê¸°ë³¸ í‚¤ì›Œë“œ ì„¹ì…˜
        let html = baseKeywords.map((k, idx) => getKwdHtml(k, idx, false)).join('');

        // ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ ì„¹ì…˜ (ì‚¬ìš©ì ì¶”ê°€ë¶„)
        if (showCustom && userKeywords.length > 0) {
            html += `<div style="font-size:0.6rem; color:#999; margin:10px 0 5px 5px; border-top:1px solid #eee; padding-top:10px;">MY CATEGORY</div>`;
            html += userKeywords.map((k, idx) => getKwdHtml(k, idx, true)).join('');
        }
        
        container.innerHTML = html;
        localStorage.setItem('base_keywords_v3', JSON.stringify(baseKeywords));
        localStorage.setItem('user_keywords_v3', JSON.stringify(userKeywords));
        document.getElementById('customModeToggle').checked = showCustom;
    }

    function selectKeyword(idx, isUser) { 
        activeIdx = idx; isActiveUserItem = isUser;
        const targetList = isUser ? userKeywords : baseKeywords;
        if(targetList[idx]) document.getElementById('currentQueryInput').value = targetList[idx].query;
        renderKeywords(); fetchAll(); 
    }

    function addKeyword() {
        const v = document.getElementById('newKeywordInput').value.trim();
        if(v) { 
            userKeywords.push({ label: v, query: v }); 
            document.getElementById('newKeywordInput').value = ""; 
            showCustom = true;
            localStorage.setItem('showCustom', true);
            renderKeywords(); 
        }
    }

    function editKeyword(idx, isUser) {
        const list = isUser ? userKeywords : baseKeywords;
        const k = list[idx];
        const newLabel = prompt("ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”:", k.label);
        if (newLabel === null) return;
        const newQuery = prompt("ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", k.query);
        if (newQuery === null) return;
        
        list[idx] = { label: newLabel, query: newQuery };
        renderKeywords();
        if (isActiveUserItem === isUser && activeIdx === idx) selectKeyword(idx, isUser);
    }

    function deleteKeyword(idx, isUser) {
        const list = isUser ? userKeywords : baseKeywords;
        if (confirm(`'${list[idx].label}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            list.splice(idx, 1);
            if (isActiveUserItem === isUser && activeIdx === idx) {
                activeIdx = 0; isActiveUserItem = false;
            }
            renderKeywords();
        }
    }
    
    function resetToDefault() { if(confirm("ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { baseKeywords = [...DEFAULT_KEYWORDS]; userKeywords = []; renderKeywords(); selectKeyword(0, false); } }
    function exportKeywords() { navigator.clipboard.writeText(JSON.stringify({ base: baseKeywords, user: userKeywords })).then(() => alert("ì„¤ì •ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.")); }
    function importKeywords() { const d = prompt("ì„¤ì • ë°ì´í„° ì…ë ¥:"); if(d) { try { const p = JSON.parse(d); baseKeywords = p.base; userKeywords = p.user; renderKeywords(); } catch(e) { alert("ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); } } }

    function isWithinDateRange(pubDateStr) {
        const d = new Date(pubDateStr);
        if (isNaN(d.getTime())) return false;
        const art = d.toISOString().split('T')[0];
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        return (!s || art >= s) && (!e || art <= e);
    }

    function applySorting(items, sortMode, isNaver) {
        if (sortMode === 'sim') return items; 
        return items.sort((a, b) => {
            const dateA = new Date(isNaver ? a.pubDate : a.querySelector("pubDate").textContent);
            const dateB = new Date(isNaver ? b.pubDate : b.querySelector("pubDate").textContent);
            return sortMode === 'desc' ? dateB - dateA : dateA - dateB;
        });
    }

    async function fetchNaver() {
        const q = document.getElementById('currentQueryInput').value;
        const startDate = document.getElementById('startDate').value;
        const sortMode = document.getElementById('naverSortSelect').value;
        const overlay = document.getElementById('naverLoading');
        const listContainer = document.getElementById('naverList');
        
        overlay.style.display = 'flex';
        listContainer.innerHTML = '';
        let allItems = [];

        try {
            const apiSort = (sortMode === 'sim') ? 'sim' : 'date';
            for (let start = 1; start <= 901; start += 100) {
                const ts = Date.now();
                const apiUrl = `https://openapi.naver.com/v1/search/news.json?query=${encodeURIComponent(q)}&display=100&start=${start}&sort=${apiSort}&_ts=${ts}`;
                const res = await fetch(PROXY + encodeURIComponent(apiUrl), { 
                    headers: { 'X-Naver-Client-Id': NAVER_ID, 'X-Naver-Client-Secret': NAVER_SECRET } 
                });
                const data = await res.json();
                if (!data.items || data.items.length === 0) break;
                allItems = allItems.concat(data.items);
                if (apiSort === 'date') {
                    const lastDate = new Date(data.items[data.items.length - 1].pubDate).toISOString().split('T')[0];
                    if (startDate && lastDate < startDate) break;
                }
            }
            const filtered = allItems.filter(i => isWithinDateRange(i.pubDate));
            const unique = Array.from(new Map(filtered.map(i => [i.link, i])).values());
            const sorted = applySorting(unique, sortMode, true);
            listContainer.innerHTML = sorted.map(i => createArticleItem(i, true)).join('') || '<div style="padding:20px; text-align:center;">ê²°ê³¼ ì—†ìŒ</div>';
        } catch(e) { console.error(e); }
        overlay.style.display = 'none';
    }

    async function fetchGoogle() {
        let q = document.getElementById('currentQueryInput').value;
        const s = document.getElementById('startDate').value, e = document.getElementById('endDate').value;
        const sortMode = document.getElementById('googleSortSelect').value;
        if(s) q += ` after:${s}`; if(e) q += ` before:${e}`;
        const overlay = document.getElementById('googleLoading');
        const listContainer = document.getElementById('googleList');
        overlay.style.display = 'flex';
        listContainer.innerHTML = '';
        try {
            const res = await fetch(PROXY + encodeURIComponent(`https://news.google.com/rss/search?q=${encodeURIComponent(q)}&hl=ko&gl=KR&ceid=KR:ko`));
            const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
            const items = Array.from(xml.querySelectorAll("item"));
            const filtered = items.filter(n => isWithinDateRange(n.querySelector("pubDate").textContent));
            const sorted = applySorting(filtered, sortMode, false);
            listContainer.innerHTML = sorted.map(n => createArticleItem(n, false)).join('') || '<div style="padding:20px; text-align:center;">ê²°ê³¼ ì—†ìŒ</div>';
        } catch(e) {}
        overlay.style.display = 'none';
    }

    function createArticleItem(item, isNaver) {
        const t = isNaver ? item.title.replace(/<[^>]*>?/gm, '').replace(/&quot;/g, '"') : item.querySelector("title").textContent;
        const u = isNaver ? item.link : item.querySelector("link").textContent;
        const desc = isNaver ? item.description.replace(/<[^>]*>?/gm, '').replace(/&quot;/g, '"') : item.querySelector("description").textContent.replace(/<[^>]*>?/gm, '');
        const pubDate = isNaver ? item.pubDate : item.querySelector("pubDate").textContent;
        const d = new Date(pubDate).toLocaleDateString();
        const p = getMediaName(u, isNaver ? null : item.querySelector("source")?.textContent);
        window.articleCache[u] = { title: t, url: u, press: p, date: d, desc: desc };
        const isS = scraps.some(s => s.url === u) ? 'active' : '';
        return `<div class="item" data-url="${u}" onclick="handleItemClick(this)"><div class="item-actions"><button class="btn-action-small btn-scrap ${isS}" onclick="handleScrapClick(event, this)">â˜…</button><button class="btn-action-small" title="ìƒˆ ì°½ ì—´ê¸°" onclick="window.open('${u}','_blank'); event.stopPropagation();">â†—</button></div><div class="item-title">${formatHighlight(t)}</div><div class="item-info"><span class="press-badge">${p}</span><span>${d}</span></div></div>`;
    }

    function getMediaName(u, s) {
        if(u.includes("naver.com")) {
            const m = u.match(/article\/(\d{3})\//) || u.match(/oid=(\d{3})/);
            if (m && OID_MAP[m[1]]) return OID_MAP[m[1]];
        }
        if(s) return s;
        try {
            const host = new URL(u).hostname.replace('www.', '');
            const parts = host.split('.');
            let key = parts[0].toLowerCase();
            if (['news','m','n','view','biz'].includes(key)) key = parts[1].toLowerCase();
            return DOMAIN_ALIAS[key] || key.toUpperCase();
        } catch(e) { return "ë‰´ìŠ¤"; }
    }

    function formatHighlight(text, localKwd = "") {
        let qVal = document.getElementById('currentQueryInput').value;
        let qKwds = qVal.replace(/[()]/g, '').split('|').map(k => k.trim()).filter(k => k.length > 1);
        let allKwds = [...new Set([...FIXED_HIGHLIGHTS, ...qKwds])];
        if (localKwd.length > 1) allKwds.push(localKwd);
        let res = text;
        allKwds.sort((a,b) => b.length - a.length).forEach(w => {
            if(!w) return;
            res = res.replace(new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi"), `<span class="hl">$1</span>`);
        });
        return res;
    }

    function reSearchList(input) {
        const tid = input.getAttribute('data-target'), val = input.value.toLowerCase();
        document.getElementById(tid).querySelectorAll('.item').forEach(item => {
            const d = window.articleCache[item.getAttribute('data-url')];
            const isMatch = d.title.toLowerCase().includes(val) || d.press.toLowerCase().includes(val) || (d.desc && d.desc.toLowerCase().includes(val));
            item.style.display = isMatch ? 'block' : 'none';
            if(isMatch) item.querySelector('.item-title').innerHTML = formatHighlight(d.title, val);
        });
    }

    function handleItemClick(el) {
        const d = window.articleCache[el.getAttribute('data-url')];
        document.querySelectorAll('.item').forEach(i => i.classList.remove('selected')); el.classList.add('selected');
        document.getElementById('previewTitle').innerText = d.title;
        document.getElementById('previewFrame').src = d.url.includes("naver.com") ? d.url.replace("n.news.naver.com", "m.news.naver.com") : d.url;
    }

    function handleScrapClick(e, btn) {
        e.stopPropagation(); const u = btn.closest('.item').getAttribute('data-url');
        const idx = scraps.findIndex(s => s.url === u);
        if (idx > -1) scraps.splice(idx, 1); else scraps.push({ ...window.articleCache[u], memo: "" });
        updateScrap();
    }

    function updateScrap() {
        localStorage.setItem('invest_scraps_v3', JSON.stringify(scraps));
        const container = document.getElementById('scrapList');
        container.innerHTML = scraps.map((s) => `<div class="scrap-card"><button style="position:absolute; top:5px; right:5px; border:none; cursor:pointer;" onclick="removeScrap('${s.url}')">âœ•</button><div onclick="window.open('${s.url}')" class="scrap-card-title">${s.title}</div><div style="font-size:0.7rem; color:#888;">${s.press} | ${s.date}</div><input type="text" class="scrap-memo" placeholder="ë¹„ê³  ì…ë ¥..." value="${s.memo || ''}" oninput="saveMemo('${s.url}', this.value)"></div>`).join('');
        document.querySelectorAll('.btn-scrap').forEach(btn => {
            const item = btn.closest('.item');
            if (item) btn.classList.toggle('active', scraps.some(s => s.url === item.getAttribute('data-url')));
        });
    }

    function saveMemo(u, t) { const idx = scraps.findIndex(s => s.url === u); if(idx > -1) { scraps[idx].memo = t; localStorage.setItem('invest_scraps_v3', JSON.stringify(scraps)); } }
    function removeScrap(u) { scraps = scraps.filter(s => s.url !== u); updateScrap(); }
    function clearScrap() { if(confirm("ìŠ¤í¬ë©ì„ ëª¨ë‘ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) { scraps = []; updateScrap(); } }
    function copyScrapReport() {
        const text = scraps.map((s, i) => `${i+1}. [${s.press}] ${s.title}\n   ë§í¬: ${s.url}\n   ë¹„ê³ : ${s.memo || '-'}`).join('\n\n');
        navigator.clipboard.writeText(text).then(() => alert("ë³´ê³ ì„œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }

    function setDatePreset(days) {
        const end = new Date(); const start = new Date(); start.setDate(end.getDate() - days);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = end.toISOString().split('T')[0];
        fetchAll();
    }

    function fetchAll() { 
        document.querySelectorAll('.local-search').forEach(i => i.value = ''); 
        window.articleCache = {}; 
        fetchNaver(); fetchGoogle(); 
    }

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today; document.getElementById('endDate').value = today;
        renderKeywords(); updateScrap(); fetchAll();
    };
</script>
</body>
</html>