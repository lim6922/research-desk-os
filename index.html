<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Research Desk v10.5 (Executive Link-First)</title>
<style>
:root{
  --bg:#f1f5f9; --panel:#ffffff; --line:#cbd5e1; --text:#0f172a;
  --muted:#64748b; --accent:#2563eb; --accent-light:#dbeafe;
  --danger:#ef4444; --warning:#f59e0b; --success:#10b981; --white:#ffffff;
}
*{box-sizing:border-box; font-family:"Pretendard",-apple-system,sans-serif;}
body{margin:0; background:var(--bg); color:var(--text); font-size:14px; line-height:1.5;}
.container{max-width:1400px; margin:0 auto; padding:20px;}
.header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--line); padding-bottom:15px;}
.sync-monitor{display:flex; gap:15px; align-items:flex-start; background:#e2e8f0; padding:8px 15px; border-radius:12px; transition:.2s;}
.sync-item {  font-size: 11px;  display: flex;  flex-direction: column;  justify-content: center;   /* ğŸ”‘ */  gap: 2px;  color: var(--muted);  min-width: 95px;  min-height: 34px; padding: 6px 0;}
.sync-item b{font-size:9px;line-height: 1;}
.sync-item span {  font-family: monospace;  font-weight: 800;  color: var(--text);  line-height: 1.05;   /* ğŸ”§ ì¤„ê°„ê²© ì¤„ì´ê¸° */  white-space: pre-line;}
.sync-warn { background: #ffedd5 !important; border: 2px solid var(--warning) !important; }
.sync-warn span { color: var(--warning) !important; }

/* ë°ì´í„° ë²„ì „ ì—­ì „ ì‹œ ë°œìƒí•˜ëŠ” ìœ„í—˜ ì•Œë¦¼ */
.sync-danger { background: #fee2e2 !important; border: 2px solid var(--danger) !important; animation: pulse 1.5s infinite; }
.sync-danger span { color: var(--danger) !important; }

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}
.url-preview-area{margin-top:12px; display:flex; flex-direction:column; gap:6px;}
.url-card{background:#f8fafc; border:1px solid var(--line); border-radius:8px; display:flex; text-decoration:none; color:inherit; overflow:hidden; transition:.2s; max-width:600px; border-left:4px solid var(--accent); box-shadow:0 2px 4px rgba(0,0,0,.02);}
.url-card:hover{background:var(--accent-light); border-color:var(--accent); transform:translateY(-1px);}
.url-thumb{width:120px; min-width:120px; height:70px; background:#eef2f6; display:flex; align-items:center; justify-content:center; overflow:hidden; border-right:1px solid var(--line);}
.url-thumb img{width:100%; height:100%; object-fit:cover;}
.url-info{padding:10px 15px; flex:1; overflow:hidden; display:flex; flex-direction:column; justify-content:center;}
.url-domain{font-size:10px; color:var(--muted); margin-bottom:2px; font-weight:800;}
.url-title{font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--accent); margin-bottom:3px;}
.url-snippet{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:.85;}
.nav-tabs{display:flex; gap:5px; margin-bottom:15px; background:#e2e8f0; padding:5px; border-radius:10px; width:fit-content;}
.nav-tabs button{padding:8px 18px; border:none; background:none; cursor:pointer; font-weight:800; color:var(--muted); border-radius:7px; transition:.2s;}
.nav-tabs button.active{background:var(--panel); color:var(--accent); box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.main-layout{display:grid; grid-template-columns:280px 1fr; gap:20px; align-items:start;}
.sidebar{position:sticky; top:20px;}
.panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,.05); margin-bottom:15px;}
.meta-row{display:grid; grid-template-columns:1.2fr .8fr 115px 1fr 1fr 1fr; gap:10px; margin-bottom:15px; align-items:flex-end;}
label{display:block; font-size:11px; font-weight:900; color:var(--muted); margin-bottom:4px; text-transform:uppercase;}
input,textarea,select{  width:100%;  padding:10px;  border:1px solid var(--line);  border-radius:8px;  outline:none;  font-size:16px; /* iOS í•„ìˆ˜ */  background:#f8fafc;}
textarea{resize:vertical;}
input:focus,textarea:focus,select:focus{border-color:var(--accent); background:var(--white);}
.btn{padding:7px 12px; border-radius:8px; border:1px solid var(--line); cursor:pointer; font-weight:800; font-size:12px; min-height:34px; /* iOS ê¶Œì¥ í„°ì¹˜ */ display:inline-flex; align-items:center; gap:6px; transition:.2s; background:#fff;}
.btn-primary{background:var(--accent); color:var(--white); border:none;}
.btn-success{background:var(--success); color:var(--white); border:none;}
.btn-ghost {  background: transparent;  border: 1px solid var(--line);  color: var(--muted);}
.btn-mini{padding:4px 8px; font-size:10px; border-radius:6px;}
.btn:disabled{opacity:.6; cursor:not-allowed;}
.card{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:20px; position:relative; transition:.3s; margin-bottom:15px;}
.card-header{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;}
.card-title{font-weight:900; color:var(--accent); cursor:pointer; font-size:15px;}
.card-title:hover{text-decoration:underline;}
.link-summary{font-size:12px; color:var(--accent); background:var(--accent-light); padding:4px 10px; border-radius:6px; display:inline-block; margin-top:4px; cursor:pointer; font-weight:700;}
.link-summary:hover{background:var(--accent); color:white;}
.trade-wrap{margin:10px 0 0; padding:12px; border-radius:10px; border:1px solid var(--success); background:#f0fdf4;}
.trade-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:8px;}
.trade-pill{display:inline-flex; gap:10px; font-size:12px; padding:8px; background:#f8fafc; border-radius:8px; border-left:4px solid var(--success);}
.capture-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:5px;}
.cap-slot{border:2px dashed var(--line); border-radius:10px; height:150px; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; background:#f8fafc; position:relative; overflow:hidden;}
.cap-slot img{width:100%; height:90px; object-fit:cover;}
.cap-note{border:none; border-top:1px solid var(--line); padding:8px; font-size:12px; background:#fff; height:60px; outline:none; resize:none;}
.cap-remove{position:absolute; top:6px; right:6px; background:var(--danger); color:#fff; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-weight:900;}
.tree-item{display:flex; justify-content:space-between; padding:10px; border-radius:8px; cursor:pointer; margin-bottom:4px; font-weight:700;}
.tree-item.active{background:var(--accent); color:var(--white);}
.explorer-item{
  padding:15px;
  margin-bottom:12px;                 /* âœ… ì¹´ë“œ ê°„ê²© */
  border:1px solid var(--line);        /* âœ… ì¹´ë“œ ì™¸ê³½ */
  border-radius:12px;                  /* âœ… ì¹´ë“œ ëŠë‚Œ */
  background:#ffffff;
  transition:.2s;
  cursor:pointer;
}

.explorer-item:hover{
  background:var(--accent-light);
  border-color:var(--accent);
}
.comment-box{margin-top:12px; border-top:1px solid #f1f5f9; padding-top:10px;}
.comment-item{font-size:14px; line-height:1.6; color:var(--muted); padding:6px 8px; background:#f8fafc; border:1px solid var(--line); border-radius:8px; margin-bottom:6px;}
.comment-input{display:flex; gap:8px; margin-top:8px;}
.comment-input input{flex:1;}
.modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:10000; padding:20px;}
.modal-content{background:var(--white); padding:30px; border-radius:16px; max-width:700px; width:100%; max-height:90vh; overflow-y:auto;}
.hidden{display:none;}
@media (max-width: 1024px) {  .main-layout {    grid-template-columns: 1fr;  }  .sidebar {    position: static;  }}
.file-btn:hover {  background: rgba(16,185,129,0.1);  color: var(--success);  border-color: var(--success);}
/* ìº¡ì³ ë³´ë“œ íŒŒì¼ ë²„íŠ¼ */
.cap-file-btn {  margin-top: 4px;  align-self: flex-start;  font-size: 12px;  border-style: dashed;  opacity: 0.85;}
.cap-file-btn:hover {  background: rgba(37,99,235,0.08);  color: var(--accent);  border-color: var(--accent);  opacity: 1;}
/* ===============================
   ìš°ì¸¡ ìƒë‹¨ ì‹œìŠ¤í…œ ë²„íŠ¼
=============================== */
.header .btn-ghost {
  border: 1px solid var(--line);
  background: transparent;
}

.header .btn-ghost:hover {
  background: rgba(37,99,235,0.08);
  border-color: var(--accent);
  color: var(--accent);
}

/* ìœ„í—˜ ë²„íŠ¼ (ì´ˆê¸°í™”) */
.header .btn-ghost[style*="--danger"]:hover {
  background: rgba(239,68,68,0.08);
  border-color: var(--danger);
  color: var(--danger);
}


/* iPad / í„°ì¹˜ìš© í”¼ë“œë°± */
.url-card:active,
.tree-item:active,
.link-summary:active,
.explorer-item:active,
.btn:active {
  transform: scale(0.97);
  opacity: 0.9;
}



.tab-content {
  height: calc(100vh - 100px);
}


/* Report ì „ìš© ë ˆì´ì•„ì›ƒ */
.report-layout {
  display: grid;
  grid-template-columns: 280px minmax(0, 1fr);
  gap: 20px;
}

/* ì¢Œì¸¡ ì¹´ë“œ íŒ¨ë„ */
.report-sidebar {
  position: sticky;
  top: 0;
  height: calc(100vh - 120px); /* í—¤ë” + íƒ­ ë†’ì´ë§Œ ì œì™¸ */
  overflow-y: auto;
}

/* ìš°ì¸¡ í¸ì§‘ ì˜ì—­ */
.report-editor textarea {
  min-height: 100px;
  margin-bottom: 18px;
}

/* ì„ íƒëœ ì¹´ë“œ ë°•ìŠ¤ */
.report-entry-box {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px;
  background: #f8fafc;
  border: 1px dashed var(--line);
  border-radius: 8px;
}

.report-hypothesis {
  position: relative;
  padding: 12px 36px 12px 14px;
  border-left: 4px solid var(--accent);
  background: #f8fafc;
  border-radius: 6px;
  font-size: 13px;
}

.report-hypothesis-title {
  font-weight: 900;
  color: var(--accent);
  margin-bottom: 4px;
}

.report-hypothesis-body {
  color: var(--text);
  line-height: 1.6;
}

.report-hypothesis button {
  position: absolute;
  top: 8px;
  right: 8px;
}


@media print {

  /* ê¸°ë³¸ ìˆ¨ê¹€ */
  body * {
    visibility: hidden;
  }

  #content-report,
  #content-report * {
    visibility: visible;
  }

  /* ì¶œë ¥ ì˜ì—­ */
  #content-report {
    position: static;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* ğŸ”‘ í•µì‹¬: grid í•´ì œ */
  .report-layout {
    display: block !important;
  }

  /* ì¢Œì¸¡ íŒ¨ë„ ì œê±° */
  .report-sidebar,
  .header,
  .nav-tabs,
  button {
    display: none !important;
  }

  /* ì¶œë ¥ ê°€ë…ì„± */
  textarea {
    border: none;
    resize: none;
  }

}

.report-section {
  margin-top: 22px;
  padding-top: 14px;
  border-top: 1px dashed var(--line);
}

.report-section h4 {
  margin: 0 0 8px;
}

/* ===============================
   Report ì…ë ¥ì°½ í™•ì¥ (v10.5)
=============================== */

/* Report ì „ìš© textarea ê¸°ë³¸ê°’ */
#reportEditorBody textarea {
  min-height: 140px;   /* ê¸°ë³¸ ë†’ì´ */
  overflow-y: hidden; /* ìŠ¤í¬ë¡¤ë°” ì œê±° (JSê°€ ë†’ì´ ì¡°ì ˆ) */
  resize: none;       /* ì‚¬ìš©ìê°€ ë“œë˜ê·¸ë¡œ ì¡°ì ˆí•˜ì§€ ì•Šê²Œ */
}



.meta-pill{
  font-size:11px;
  padding:4px 8px;
  border-radius:6px;
  background:#f1f5f9;
  border:1px solid var(--line);
  margin-right:4px;
  font-weight:700;
}
.meta-pill.sector{ color:#1d4ed8; }
.meta-pill.tag{ color:#0f766e; }



/* ì•ŒëŒ ì…ë ¥ í•„ë“œ ì •ë ¬ ë³´ì • */
#alarmFields input {
  font-size: 16px;
  padding: 10px;
}

/* ì•ŒëŒ ë¸”ë¡ ë†’ì´ í†µì¼ */
.trade-wrap {
  min-height: 56px;
}


.alarm-badge{
  font-size:10px;
  font-weight:900;
  padding:3px 7px;
  border-radius:7px;
  margin-left:7px;
  display:inline-block;
}

.alarm-badge.upcoming{
  background:#e0f2fe;
  color:#0369a1;
}

.alarm-badge.today{
  background:#fef3c7;
  color:#92400e;
}

.alarm-badge.overdue{
  background:#fee2e2;
  color:#991b1b;
}

.alarm-badge.done{
  background:#ecfeff;
  color:#065f46;
}


/* Explorer ì„œë¸Œ íŒ¨ë„ ê°•ì¡° ìŠ¤íƒ€ì¼ */
.panel-highlight {
  border: 2px solid;
  background: #f8fafc;
}

.panel-highlight.alarm {
  border-color: var(--warning);
  background: #fffbeb;
}

.panel-highlight.review {
  border-color: var(--success);
  background: #f0fdf4;
}



.hl-mark-url{ background:#dbeafe; }
.hl-mark-tag{
  background:#fde047;
  color:#000;
  font-weight:900;
  padding:1px 4px;
  border-radius:4px;
}
.hl-mark-code{ background:#fef3c7; }


/* ===============================
   Markdown Support
=============================== */

.md-h1 { 
  font-size:18px; 
  font-weight:900; 
  margin:10px 0 6px; 
  color:var(--accent);
}

.md-h2 { 
  font-size:16px; 
  font-weight:800; 
  margin:8px 0 4px; 
  color:#1e40af;
}

.md-h3 { 
  font-size:14px; 
  font-weight:800; 
  margin:6px 0 4px; 
}

.md-bold { font-weight:900; }

.md-underline {
  text-decoration: underline;
}

.md-italic { font-style:italic; opacity:.85; }

.md-quote {
  border-left:4px solid var(--accent);
  padding:6px 10px;
  background:#f1f5f9;
  font-size:13px;
  margin:6px 0;
}

.md-hr {
  border-top:1px dashed var(--line);
  margin:10px 0;
}

.md-li {
  padding-left:16px;
  position:relative;
  margin:4px 0;
}

.md-li::before {
  content:"â€¢";
  position:absolute;
  left:0;
  color:var(--accent);
}

#reportContainer{
  height: calc(100vh - 180px);
  overflow-y: auto;
}


</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="display:flex; align-items:center; gap:20px;">
      <h2 style="margin:0; color:var(--accent); font-size:22px;">ğŸ‘‘ Research Desk</h2>
      <div id="syncSentinel" class="sync-monitor">
        <div class="sync-item"><b>Local DB</b> <span id="localLastTs">-</span></div>
        <div class="sync-item"><b>Import</b> <span id="importLastTs">-</span></div>
        <div class="sync-item"><b>Export</b> <span id="exportLastTs">-</span></div>
        <div class="sync-item"><b>Quote Sync</b> <span id="quoteLastTs">-</span></div>
      </div>
    </div>
    <div style="
  background:rgba(255,255,255,0.6);
  backdrop-filter: blur(6px);
  border:1px solid var(--line);
  padding:8px;
  border-radius:8px;
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  align-items:flex-start;
">
      <button class="btn btn-ghost" onclick="toggleModal('helpModal')">â” ê°€ì´ë“œ</button>
      <button class="btn btn-primary" onclick="exportData()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      <label class="btn btn-ghost" style="margin:0; cursor:pointer;">
        ğŸ“¥ ê°€ì ¸ì˜¤ê¸° <input type="file" hidden onchange="importData(event)">
      </label>
      <button class="btn btn-ghost" style="color:var(--danger)" onclick="resetAll()">âš ï¸ ì´ˆê¸°í™”</button>
      <button class="btn btn-ghost" onclick="syncQuotes()">ğŸ“Š ì „ì²´ ì‹œì„¸ ë™ê¸°í™”</button>
    </div>
  </div>

  <div class="nav-tabs">
    <button onclick="switchTab('monitor')" id="tab-monitor">ğŸ“… ì¼ì • íˆ¬ì ëª¨ë‹ˆí„°ë§</button>
    <button onclick="switchTab('desk')" id="tab-desk" class="active">âœï¸ ë¶„ì„ ë°ìŠ¤í¬</button>
    <button onclick="switchTab('explorer')" id="tab-explorer">ğŸ” ì‹¬í™” íƒìƒ‰ ë° ì§€ì‹ë§µ</button>
    <button onclick="switchTab('report')" id="tab-report">  ğŸ§¾ ë ˆí¬íŠ¸</button>
  </div>

  <!-- TAB: DESK -->
  <div id="content-desk" class="tab-content active">
    <button class="btn btn-ghost" onclick="toggleInputPanel()" style="margin-bottom:10px;">ğŸ“ ì…ë ¥ì°½ í† ê¸€ (ìˆ¨ê¹€/ë³´ì„)</button>
    <div id="inputPanel" class="panel">
      <div class="meta-row">
        <div><label>ì¢…ëª©ëª…</label><input id="tickerName" placeholder="ex) ì‚¼ì„±ì „ì"></div>
        <div><label>ì½”ë“œ(í‹°ì»¤)</label><input id="tickerCode" placeholder="ex) 005930"></div>
        <button id="lookupBtn" class="btn btn-success btn-lookup" style="padding:10px; width:100%; font-size:11px;" onclick="webMapTicker()">ì½”ë“œ ì¡°íšŒ</button>
        <div><label>ë‚ ì§œ</label><input id="date" type="date"></div>
        <div><label>ì„¹í„°</label><input id="sector" placeholder="ex) ë°˜ë„ì²´"></div>
        <div><label>íƒœê·¸</label><input id="tags" placeholder="ex) ì‹¤ì ë°œí‘œ"></div>
      </div>
      <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px; margin-bottom:10px;">
        <div>
          <label>í•µì‹¬ ê°€ì„¤ (Hypothesis + URLs)</label>
          <textarea id="content"
          style="height:100px;"
          placeholder="ì„¼í„°ì¥ë‹˜ì˜ í•µì‹¬ ê°€ì„¤ê³¼ ê´€ë ¨ URLì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
        </div>
        <div>
          <label>ë¬´íš¨í™” ì¡°ê±´ (Risk)</label>
          <textarea id="invalidation" style="height:100px;" placeholder="ê°€ì„¤ì´ í‹€ë ¸ìŒì„ ì¸ì •í•˜ëŠ” ì¡°ê±´..."></textarea>
        </div>
      </div>
      <div class="trade-wrap">
        <label style="display:inline-flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
          <input type="checkbox" id="isTrade" style="width:auto;" onchange="toggleTradeFields(this.checked)">
          <span style="font-weight:900; color:var(--text);">ë§¤ë§¤ ê¸°ë¡ í™œì„±í™”</span>
        </label>
        <div id="tradeFields" class="trade-grid hidden">
          <div><label style="margin-top:10px;">ì§„ì…ê°€</label><input id="entry" type="number" placeholder="0"></div>
          <div><label style="margin-top:10px;">ëª©í‘œê°€</label><input id="target" type="number" placeholder="0"></div>
          <div><label style="margin-top:10px;">ì†ì ˆê°€</label><input id="stop" type="number" placeholder="0"></div>
          <div><label style="margin-top:10px;">ìƒíƒœ</label>
            <select id="status">
              <option value="ACTIVE">ìš´ìš©ì¤‘</option>
              <option value="CLOSED">ì¢…ë£Œ</option>
            </select>
          </div>
        </div>
      </div>

<div class="trade-wrap" style="border-color:var(--warning); background:#fffbeb;">
  <label style="
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin:0;
  cursor:pointer;
">
    <input
  type="checkbox"
  id="isAlarm"
  style="width:16px; height:16px;"
  onchange="toggleAlarmFields(this.checked)">
    <b>â° ì•ŒëŒ í™œì„±í™”</b>
  </label>

  <div id="alarmFields" class="trade-grid hidden">
    <div>
      <label>ì•ŒëŒ ë‚ ì§œ</label>
      <input type="date" id="alarmDate">
    </div>
    <div>
      <label>ë©°ì¹  í›„</label>
      <input type="number" id="alarmAfter" placeholder="ex) 7">
    </div>
  </div>
</div>


      <div style="margin-top:12px;">
        <label>ì‹œê° ìë£Œ ë° ìº¡ì²˜ (ìµœëŒ€ 3ê°œ / Ctrl+V)</label>
        <div id="captureBoard" class="capture-grid"></div>
<label class="btn btn-ghost file-btn cap-file-btn">
  ğŸ“ ì´ë¯¸ì§€ ì¶”ê°€
  <input type="file"
         accept="image/*"
         multiple
         hidden
         onchange="handleImageUpload(this.files)">
</label>
      </div>
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; padding-top:15px; border-top:1px solid var(--line);">
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn btn-primary" onclick="saveEntry()" style="padding:12px 40px; font-size:14px;">ê°€ì„¤ ìŠ¹ì¸ ë° ì €ì¥</button>
          <button class="btn btn-ghost" onclick="openLinkModal(null)">ğŸ”— ë¶„ì„ ì—°ê²°</button>
          <button class="btn btn-ghost" onclick="clearForm()">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="sidebar">
        <div class="panel">
          <input id="treeSearch"
       placeholder="ì¢…ëª© / ì„¹í„° / íƒœê·¸ / ë‚´ìš© ê²€ìƒ‰"
       style="margin-bottom:10px;"
       oninput="handleDeskSearch(this.value)">
          <div id="treeList"></div>
        </div>
      </div>
      <div class="content">
        <div id="timeline"></div>
      </div>
    </div>
  </div>


  <!-- TAB: ì¼ì •íˆ¬ì ëª¨ë‹ˆí„°ë§ -->
<div id="content-monitor" class="tab-content">
  <iframe 
    src="ì„ì˜ì¬_ì¼ì • íˆ¬ììš© ê¸°ì‚¬ ëª¨ë‹ˆí„°ë§v260118_1700.html"
    style="
      width:100%;
      height:100%;
      border:none;
      border-radius:12px;
      background:#f4f7fa;
    "
    loading="lazy">
  </iframe>
</div>


  <!-- TAB: EXPLORER -->

  <div id="content-explorer" class="tab-content">
    
<!-- ì•ŒëŒ ëŒ€ê¸° ê°€ì„¤ -->
<div class="panel panel-highlight alarm" style="margin-bottom:15px;">
  <label>â° ì•ŒëŒ ëŒ€ê¸° ê°€ì„¤</label>
  <div id="alarmQueue"></div>
</div>

<!-- ë¦¬ë·° ëŒ€ìƒ ê°€ì„¤ -->
<div class="panel panel-highlight review" style="margin-bottom:15px;">
  <label>ğŸ” ë¦¬ë·° ëŒ€ìƒ ê°€ì„¤ (ì‹œê°„ ê²½ê³¼)</label>
  <div id="reviewQueue"></div>
</div>


<div class="panel" style="background:var(--accent-light); border-color:var(--accent);">
      <label style="color:var(--accent);">Global Intelligence Explorer</label>
      <input id="explorerGlobalSearch" placeholder="ê°€ì„¤ ë‚´ìš©, ì¢…ëª©, íƒœê·¸ í†µí•© ê²€ìƒ‰..." style="padding:15px; font-size:15px; border:2px solid var(--accent);" oninput="renderExplorer()">
    </div>
    <div class="main-layout" style="grid-template-columns:1fr 1fr;">
      <div class="panel"><h3 style="margin-top:0;">ğŸ•’ ìµœê·¼ ë¶„ì„ íˆìŠ¤í† ë¦¬</h3><div id="explorerSearchResults"></div></div>
      <div class="panel"><h3 style="margin-top:0;">ğŸ”— ì§€ì‹ ë„¤íŠ¸ì›Œí¬ (Link Map)</h3><div id="knowledgeLinkList"></div></div>
    </div>
  </div>


  <!-- TAB: REPORT-->
<div id="content-report" class="tab-content">

    <div class="panel"
     style="
       display:flex;
       gap:10px;
       align-items:center;
       margin-bottom:15px;
       flex-wrap:wrap;
     ">

  <!-- ì¢Œì¸¡: ê¸°ë³¸ ë²„íŠ¼ -->
  <button class="btn btn-primary" onclick="newReport()">â• ì‹ ê·œ</button>
  <button class="btn btn-success" onclick="saveReport()">ğŸ’¾ ì €ì¥</button>
<button class="btn btn-ghost"        onclick="resetReportEditor()">  â™»ï¸ ì…ë ¥ ì´ˆê¸°í™”</button>
  <button class="btn btn-ghost" onclick="printReport()">ğŸ–¨ ì¶œë ¥</button>


  <!-- êµ¬ë¶„ì„  -->
  <div style="width:1px; height:28px; background:var(--line); margin:0 6px;"></div>

  

  <span style="margin-left:auto; font-size:12px; color:var(--muted);">
    ğŸ§¾ Report Editor
  </span>
</div>


  <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
  <div class="report-layout">

    <!-- ì¢Œì¸¡: ë ˆí¬íŠ¸ ëª©ë¡ -->
<div class="panel report-sidebar">
  <label>ğŸ“š ë ˆí¬íŠ¸ ëª©ë¡</label>

  <input
    id="reportSearch"
    placeholder="ë ˆí¬íŠ¸ ê²€ìƒ‰..."
    style="margin:8px 0 12px;"
  />

  <div id="reportList"></div>
</div>


  <div id="reportContainer">







<!-- ğŸ§¾ ë¸”ë­í¬ ìƒíƒœ -->
<div id="reportBlankState"
     style="
       display:none;
       padding:40px;
       text-align:center;
       color:var(--muted);
     ">

  <h3 style="margin-bottom:12px;">ğŸ§¾ ë ˆí¬íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>

  <p style="font-size:13px; line-height:1.8;">
    ì¢Œì¸¡ ëª©ë¡ì—ì„œ ë ˆí¬íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜<br>
    ìƒˆ ë ˆí¬íŠ¸ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.
  </p>

  <button class="btn btn-primary"
          style="margin-top:20px;"
          onclick="newReport()">
    â• ì‹ ê·œ ë ˆí¬íŠ¸ ë§Œë“¤ê¸°
  </button>
</div>


<div id="reportEditorBody">
    <!-- ìš°ì¸¡: ë ˆí¬íŠ¸ ë³¸ë¬¸ -->

<!-- ë©”íƒ€ -->
<div style="
  display:grid;
  grid-template-columns:160px 120px 120px 80px;
  gap:10px;
  margin-bottom:10px;
  align-items:end;
">

  <div>
    <label>ëŒ€í‘œ ì¢…ëª©ëª…</label>
    <input id="reportTickerName" placeholder="ex) ì‚¼ì„±ì „ì">
  </div>

  <div>
    <label>ì¢…ëª©ì½”ë“œ</label>
    <input id="reportTickerCode" placeholder="ex) 005930 / AAPL">
  </div>




  <div>
    <label>í˜„ì¬ ì‹œì„¸</label>
    <input id="reportPrice"
       placeholder="ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥"
       style="background:#fff;">
  </div>

  <div>
    <label></label>
    <button class="btn btn-ghost btn-mini"
            style="width:100%;"
            onclick="refreshReportPrice()">ğŸ“Š ì‹œì„¸ ê°±ì‹ </button>
  </div>

</div>

<div style="
  display:grid;
  grid-template-columns:160px 1fr;
  gap:10px;
  margin-bottom:15px;
  align-items:end;
">

  <div>
    <label>ë ˆí¬íŠ¸ ë‚ ì§œ</label>
    <input type="date" id="reportDate">
  </div>

  <div>
    <label>ë ˆí¬íŠ¸ ì œëª©</label>
    <input id="reportTitle"
           placeholder="ex) 2026.02 ë°˜ë„ì²´ ì£¼ê°„ ì½”ë©˜íŠ¸">


</div>

  

</div>
<!-- 1. ê·¼ê±° ê°€ì„¤ -->
<div style="
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:10px;
">
  <h4 style="margin:0;">
    1. ê·¼ê±° ê°€ì„¤ (Key Hypotheses)
  </h4>

  <button class="btn btn-mini btn-ghost"
          onclick="openReportEntryModal()">
    â• ì¹´ë“œ ì¶”ê°€
  </button>
</div>

<!-- âœ… ê·¼ê±° ê°€ì„¤ ì¹´ë“œ ì¶œë ¥ ì˜ì—­ (í•„ìˆ˜) -->
<div id="reportEntryList" class="report-entry-box"></div>

  <!-- ì„¼í„° ì˜ê²¬ -->
  <label style="margin-top:10px;">ì„¼í„° ì˜ê²¬ (One-liner)</label>
  <textarea id="reportOpinion"
            placeholder="ì„¼í„°ì˜ ê²°ë¡  ìš”ì•½"
            style="min-height:60px;"></textarea>

  <!-- 2. Executive Summary -->
  <div class="report-section">
  <h4>
    2. Executive Summary
    <button class="btn btn-mini btn-ghost"
            onclick="openReportSectionEntryModal('summary')">
      ğŸ”— ì¹´ë“œ ì¶”ê°€
    </button>
  </h4>

  <div id="summaryCardList" class="report-entry-box"></div>
  <textarea id="sec-summary"></textarea>
</div>

  <!-- 3. Macro Environment -->
  <div class="report-section">
    <h4>3. Macro Environment
    <button class="btn btn-mini btn-ghost"
            onclick="openReportSectionEntryModal('macro')">
      ğŸ”— ì¹´ë“œ ì¶”ê°€
    </button>
</h4>
  <div id="macroCardList" class="report-entry-box"></div>
    <textarea id="sec-macro"></textarea>
  </div>

  <!-- 4. Sector View -->
  <div class="report-section">
  <h4>
    4. Sector View
    <button class="btn btn-mini btn-ghost"
            onclick="openReportSectionEntryModal('sector')">
      ğŸ”— ì¹´ë“œ ì¶”ê°€
    </button>
  </h4>

  <div id="sectorCardList" class="report-entry-box"></div>
  <textarea id="sec-sector"></textarea>
</div>

  <!-- 5. Conclusion & Action -->
 <div class="report-section">
  <h4>
    5. Conclusion & Action
    <button class="btn btn-mini btn-ghost"
            onclick="openReportSectionEntryModal('conclusion')">
      ğŸ”— ì¹´ë“œ ì¶”ê°€
    </button>
  </h4>

  <div id="conclusionCardList" class="report-entry-box"></div>
  <textarea id="sec-conclusion"></textarea>
</div>






<!-- MODALS -->
<div id="linkModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0;">ğŸ”— ë¦¬í¬íŠ¸ ìƒí˜¸ ì—°ê²°</h3>
      <button class="btn btn-ghost" onclick="toggleModal('linkModal')">ë‹«ê¸°</button>
    </div>
    <input id="linkSearch" placeholder="ì—°ê²°í•  ê°€ì„¤ í‚¤ì›Œë“œë‚˜ ì¢…ëª© ê²€ìƒ‰..." style="margin-bottom:15px;" oninput="renderLinkOptions(this.value)">
    <div id="linkOptions" style="max-height:450px; overflow-y:auto; border:1px solid var(--line); border-radius:10px;"></div>
  </div>
</div>

<!-- â” ê°€ì´ë“œ ëª¨ë‹¬ -->
<div id="helpModal" class="modal" onclick="toggleModal('helpModal')">
  <div class="modal-content" onclick="event.stopPropagation()">

    <h3>ğŸ“˜ Research Desk v10.5 ê°€ì´ë“œ</h3>

<div style="font-size:13px; line-height:1.9; color:var(--muted);">

<b style="color:var(--text); font-size:15px;">ğŸ§  Research Desk ê°œìš”</b><br>
Research DeskëŠ” ë‹¨ìˆœ ë©”ëª¨ì¥ì´ ì•„ë‹ˆë¼,<br>
<b>ê°€ì„¤ â†’ ê·¼ê±° â†’ ë¬´íš¨í™” ì¡°ê±´ â†’ ê²€ì¦</b> êµ¬ì¡°ë¥¼ ê°–ì¶˜ ë¦¬ì„œì¹˜ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.<br>
ëª¨ë“  ê¸°ë¡ì€ ì‹œê°„ìˆœìœ¼ë¡œ ì¶•ì ë˜ë©° íŒë‹¨ì˜ íˆìŠ¤í† ë¦¬ê°€ ë©ë‹ˆë‹¤.<br><br>

<b style="color:var(--text);">ğŸ“Œ í•µì‹¬ ì›ì¹™</b><br>
1) ë°˜ë“œì‹œ <b>ê°€ì„¤ + ê·¼ê±°(URL)</b>ë¥¼ í•¨ê»˜ ê¸°ë¡í•©ë‹ˆë‹¤.<br>
2) ë°˜ë“œì‹œ <b>ë¬´íš¨í™” ì¡°ê±´(Risk)</b>ì„ ëª…ì‹œí•©ë‹ˆë‹¤.<br>
3) ê¸°ë¡ì€ ê²€ì¦ì„ ìœ„í•œ ìì‚°ì…ë‹ˆë‹¤.<br><br>

<hr style="margin:18px 0; border:none; border-top:1px dashed var(--line);">

<b style="color:var(--text); font-size:14px;">ğŸ§­ ê¸°ë³¸ ì‚¬ìš© íë¦„</b><br><br>

â‘  ì¢…ëª©ëª… + ì½”ë“œ ì…ë ¥<br>
â‘¡ <b>Ctrl + Shift + C</b> â†’ ì¢…ëª© ì½”ë“œ ì¡°íšŒ<br>
â‘¢ ê°€ì„¤ + ê·¼ê±° + ë¦¬ìŠ¤í¬ ì…ë ¥<br>
â‘£ (ì„ íƒ) ë§¤ë§¤ ê¸°ë¡ í™œì„±í™”<br>
â‘¤ <b>Ctrl + Enter</b> â†’ ì €ì¥<br><br>

ì´ë¯¸ì§€ëŠ” <b>Ctrl + V</b>ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥ (ìµœëŒ€ 3ì¥).<br>
í´ë¦­ ì‹œ í™•ëŒ€ + íœ ë©”ëª¨ ì €ì¥ ê°€ëŠ¥.<br><br>

<hr style="margin:18px 0; border:none; border-top:1px dashed var(--line);">

<b style="color:var(--text); font-size:14px;">âŒ¨ï¸ ë‹¨ì¶•í‚¤ ì•ˆë‚´</b><br><br>

<b style="color:var(--text);">ğŸ“Œ ì „ì—­</b><br>
â€¢ <b>Ctrl + Enter</b> : ì €ì¥ (Desk / Report)<br>
â€¢ <b>Ctrl + Shift + F</b> : í˜„ì¬ íƒ­ ê²€ìƒ‰ì°½ ì´ë™<br>
â€¢ <b>Ctrl + Shift + C</b> : ì¢…ëª© ì½”ë“œ ì¡°íšŒ<br>
â€¢ <b>Ctrl + Shift + Q</b> : í˜„ì¬ ì¢…ëª© ì‹œì„¸ ê°±ì‹ <br>
â€¢ <b>Ctrl + Alt + Q</b> : ì „ì²´ ì‹œì„¸ ë™ê¸°í™”<br>
â€¢ <b>Ctrl + Alt + D</b> : Desk íƒ­ ì´ë™<br>
â€¢ <b>Ctrl + Alt + M</b> : Monitor íƒ­ ì´ë™<br>
â€¢ <b>Ctrl + Alt + E

    <button class="btn btn-primary"
            style="margin-top:20px; width:100%;"
            onclick="toggleModal('helpModal')">
      ê°€ì´ë“œ ë‹«ê¸°
    </button>

  </div>
</div>

<div id="lightbox" class="modal" onclick="this.style.display='none'">
  <div style="
    background:rgba(255,255,255,0.6);
    backdrop-filter: blur(6px);
    padding:20px;
    border-radius:12px;
    max-width:90%;
    max-height:90%;
    display:flex;
    gap:16px;
    align-items:flex-start;
  " onclick="event.stopPropagation()">

<!-- ğŸ–¼ ì´ë¯¸ì§€ + íœ ìº”ë²„ìŠ¤ ë˜í¼ -->
<div id="imgCanvasWrap"
     style="
       position:relative;
       display:inline-block;
       max-width:60vw;
       max-height:80vh;
     ">

  <img id="lbImg"
       style="
         display:block;
         max-width:100%;
         max-height:80vh;
         border-radius:8px;
       ">

  <!-- âœï¸ íœ / ë§ˆìš°ìŠ¤ ìº”ë²„ìŠ¤ -->
  <canvas id="penCanvas"
          style="
            position:absolute;
            left:0;
            top:0;
            touch-action:none;
            border-radius:8px;
          ">
  </canvas>

</div>

<div id="lbNoteWrap"
     style="
       max-width:320px;
       display:none;
       flex-direction:column;
       gap:8px;
     ">

  <textarea id="lbNoteInput"
    style="
      width:100%;
      min-height:120px;
      padding:10px;
      font-size:12px;
      line-height:1.6;
      background:#fffbea;
      border:1px solid #fde68a;
      border-radius:6px;
      color:#713f12;
      resize:vertical;
    "
    placeholder="ìº¡ì²˜ ë©”ëª¨ ìˆ˜ì •..."
  ></textarea>

  <button class="btn btn-success btn-mini"
          onclick="saveLightboxNote()">
    âœ” ë©”ëª¨ ì €ì¥
  </button>

<button class="btn btn-primary btn-mini"
        onclick="savePenToImage()">
  âœï¸ íœ ë©”ëª¨ ì €ì¥
</button>

</div>

  </div>
</div>

<script>
// ================================================
// ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
// ================================================
let db = JSON.parse(localStorage.getItem('rd_v10_5') || '{"entries":[],"reports":[],"meta":{"lastImportAt":0,"lastExportAt":0,"lastQuoteSyncAt":0}}');
if (!db.meta) db.meta = { lastImportAt:0, lastExportAt:0, lastQuoteSyncAt:0 };

let draftImages = [];
let draftLinks = [];
let editingId = null;
let selectedTicker = "ALL";
let linkingTargetId = null;
let editingComment = { entryId: null, index: null };
let lightboxImageIndex = null;
let lightboxMode = "draft"; // "draft" | "entry"
let lightboxEntryId = null;
let editingReportId = null;
let reportDraft = null;
let reportTargetSection = null;
let deskSearchQuery = "";

// ì´ˆê¸° ì„¤ì •
document.getElementById('date').value = new Date().toISOString().split('T')[0];
renderCaptureBoard();
renderAll();
updateSyncStatus();
renderReportList(); // âœ… ì¶”ê°€
updateReportEditorState(); // âœ… ì¶”ê°€: reportDraft=nullì´ë©´ ë¸”ë­í¬ í‘œì‹œ
checkAlarms();   // ğŸ”” ì—¬ê¸°

document.getElementById('reportSearch')
  ?.addEventListener('input', filterReport);

// ================================================
// í—¬í¼ í•¨ìˆ˜ë“¤
// ================================================
function getSummary(text) {
  if (!text) return "";
  const firstLine = text.split('\n')[0];
  return firstLine.length > 40 ? firstLine.substring(0, 40) + "..." : firstLine;
}

function getTickerSeq(e) {
  const base = db.entries
    .filter(x => selectedTicker === "ALL" ? x.tickerCode === e.tickerCode : x.tickerCode === selectedTicker)
    .sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
  return base.indexOf(e) + 1;
}

function toggleTradeFields(on) {
  document.getElementById('tradeFields').classList.toggle('hidden', !on);
}

function fmtNum(v) {
  if (v == null || v === "") return "-";
  const n = Number(v);
  return isNaN(n) ? String(v) : n.toLocaleString();
}

function calcROI(entry, current) {
  if (!entry || !current || entry == 0) return "";
  const roi = ((current - entry) / entry * 100).toFixed(2);
  const color = roi > 0 ? 'var(--success)' : 'var(--danger)';
  return `<span style="color:${color}; font-weight:800;">ROI: ${roi}%</span>`;
}

function toggleInputPanel() {
  const p = document.getElementById('inputPanel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

// ================================================
// URL ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨
// ================================================
function extractUrls(text) {
  return (text.match(/https?:\/\/[^\s)<>"']+/g) || []);
}

function generateUrlPreviewHtml(text) {
  const urls = [...new Set(extractUrls(text))];
  if (!urls.length) return "";
  let html = '<div class="url-preview-area">';
  urls.forEach((url, i) => {
    const id = `urlpv-${Date.now()}-${i}`;
    let domain = "link";
    try { domain = new URL(url).hostname; } catch {}
    html += `
      <a href="${url}" target="_blank" class="url-card" id="${id}" data-url="${encodeURIComponent(url)}">
        <div class="url-thumb" data-thumb><span style="font-size:24px; opacity:0.3;">ğŸ”—</span></div>
        <div class="url-info">
          <div class="url-domain">${domain}</div>
          <div class="url-title" data-title>${domain} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <div class="url-snippet" data-desc>${url}</div>
        </div>
      </a>`;
  });
  html += '</div>';
  let hydrateTimer;
clearTimeout(hydrateTimer);
hydrateTimer = setTimeout(hydrateUrlCards, 100);
  return html;
}

const URLMETA_CACHE_KEY = "rd_urlmeta_cache_v2";

function loadMetaCache() {
  try { return JSON.parse(localStorage.getItem(URLMETA_CACHE_KEY) || "{}"); }
  catch { return {}; }
}

function saveMetaCache(cache) {
  try { localStorage.setItem(URLMETA_CACHE_KEY, JSON.stringify(cache)); } catch {}
}

function isYoutubeUrl(url) {
  return url.includes("youtube.com/watch") || url.includes("youtu.be/");
}

function getYoutubeId(url) {
  try {
    if (url.includes("v=")) return url.split("v=")[1].split("&")[0];
    return new URL(url).pathname.replace(/^\//, "").split("/")[0];
  } catch { return ""; }
}

async function fetchUrlMeta(url) {
  if (isYoutubeUrl(url)) {
    const vid = getYoutubeId(url);
    const thumb = vid ? `https://img.youtube.com/vi/${vid}/mqdefault.jpg` : "";
    const oembed = `https://noembed.com/embed?url=${encodeURIComponent(url)}`;
    try {
      const res = await fetch(oembed);
      const data = await res.json();
      return {
        title: data.title || "YouTube ì˜ìƒ",
        desc: data.author_name ? `ì±„ë„: ${data.author_name}` : url,
        image: data.thumbnail_url || thumb
      };
    } catch {
      try {
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(oembed)}`);
        const data = await res.json();
        return {
          title: data.title || "YouTube ì˜ìƒ",
          desc: data.author_name ? `ì±„ë„: ${data.author_name}` : url,
          image: data.thumbnail_url || thumb
        };
      } catch {
        return { title: "YouTube ì˜ìƒ", desc: url, image: thumb };
      }
    }
  }

  let title = "", desc = "", image = "";
  try {
    const jina = `https://r.jina.ai/${encodeURIComponent(url)}`;
    let txt = await (await fetch(jina)).text();
    title = txt.match(/<title>([^<]+)<\/title>/i)?.[1] ||
            txt.match(/property=["']og:title["'][^>]*content=["']([^"']+)["']/i)?.[1] || "";
    desc  = txt.match(/name=["']description["'][^>]*content=["']([^"']+)["']/i)?.[1] || "";
    image = txt.match(/property=["']og:image["'][^>]*content=["']([^"']+)["']/i)?.[1] || "";
  } catch {
    try {
      const proxy = `https://corsproxy.io/?${encodeURIComponent(url)}`;
      const txt = await (await fetch(proxy)).text();
      title = txt.match(/<title>([^<]+)<\/title>/i)?.[1] || new URL(url).hostname;
      desc  = txt.match(/name=["']description["'][^>]*content=["']([^"']+)["']/i)?.[1] || "";
      image = txt.match(/property=["']og:image["'][^>]*content=["']([^"']+)["']/i)?.[1] || "";
    } catch {}
  }

  title = title || `${new URL(url).hostname} ê¸°ì‚¬`;
  return { title, desc: desc || "ìš”ì•½ ì—†ìŒ", image: image.trim() || "" };
}

function applyMetaToCard(card, meta) {
  const t  = card.querySelector("[data-title]");
  const d  = card.querySelector("[data-desc]");
  const th = card.querySelector("[data-thumb]");

  if (t) {
    t.textContent = meta.title;
    t.dataset.done = "1";
  }

  if (d) {
    d.textContent = meta.desc;
  }

  if (th) {
    th.innerHTML = meta.image
      ? `<img src="${meta.image}" alt=""
           onerror="this.style.display='none';
                    this.parentElement.innerHTML='ğŸ“„';">`
      : `<span style="font-size:24px; opacity:0.3;">ğŸ”—</span>`;
  }
}

async function hydrateUrlCards() {
  const cards = [...document.querySelectorAll(".url-card[data-url]")];
  const cache = loadMetaCache();

  const tasks = cards.map(async card => {
    const url = decodeURIComponent(card.dataset.url || "");
    if (!url) return;

    const titleEl = card.querySelector("[data-title]");
    if (titleEl?.dataset.done === "1") return;

    let meta;

    if (cache[url]) {
      meta = cache[url];
    } else {
      try {
        meta = await fetchUrlMeta(url);
        cache[url] = meta;
      } catch {
        meta = {
          title: new URL(url).hostname + " ë°”ë¡œê°€ê¸°",
          desc: "",
          image: ""
        };
      }
    }

    // âœ… ì—¬ê¸°ì„œë§Œ ë³´ì •
    if (!meta.desc || meta.desc === "ìš”ì•½ ì—†ìŒ") {
      meta.desc = getPlatformLabel(url) + " Â· ìš”ì•½ ë¯¸ì œê³µ";
    }

    applyMetaToCard(card, meta);
  });

  await Promise.all(tasks);
  saveMetaCache(cache);
}


// ================================================
// ì¹´ë“œ / íƒ€ì„ë¼ì¸ ë Œë”ë§
// ================================================
function createCardHtml(e) {

const ageDays = getAgeDays(e);
const ageBucket = getAgeBucket(ageDays);

const ageBadge = ageBucket
  ? `<span
       style="
         margin-left:6px;
         font-size:10px;
         padding:2px 6px;
         border-radius:6px;
         background:${ageBucket.bg};
         color:${ageBucket.color};
         font-weight:900;
       "
       title="ê²½ê³¼ ${ageDays}ì¼"
     >
       â³ ${ageBucket.label}
     </span>`
  : '';



let alarmBadge = "";

if (e.isAlarm && e.alarm && e.alarm.date) {
  const today = new Date().toISOString().split('T')[0];
  const diff =
    Math.ceil(
      (new Date(e.alarm.date) - new Date(today)) / 86400000
    );

  if (e.alarm.done) {
    alarmBadge = `<span class="alarm-badge done">â° DONE</span>`;
  } else if (diff < 0) {
    alarmBadge = `<span class="alarm-badge overdue">â° D+${Math.abs(diff)}</span>`;
  } else if (diff === 0) {
    alarmBadge = `<span class="alarm-badge today">â° TODAY</span>`;
  } else {
    alarmBadge = `<span class="alarm-badge upcoming">â° D-${diff}</span>`;
  }
}


  const outgoingLinks = e.links || [];
  const incomingLinks = db.entries.filter(x => (x.links || []).includes(e.id));
  const incoming = getIncomingLinks(e.id);
  const incomingBadge = incoming.length
    ? `<span class="link-summary"
              style="background:#ecfeff;color:#0369a1;"
              onclick="jumpToNote(${incoming[0].id})">
         â†” ì—°ê²°ë¨ ${incoming.length}
       </span>`
    : '';

  const usedInReports = getReportsUsingEntry(e.id);
  const reportBadges = usedInReports.map(r => `
    <span class="link-summary"
          style="background:#fef3c7; color:#92400e;"
          onclick="openReport(${r.id})">
      ğŸ§¾ ${r.title || "(ì œëª© ì—†ìŒ)"}
    </span>
  `).join("");

  const urlPreview = generateUrlPreviewHtml(e.content);
  const seq = getTickerSeq(e);
  const price = e.currentPrice
  ? `<span style="color:var(--success); margin-left:8px;">
       í˜„ì¬ê°€ ${fmtNum(e.currentPrice)}
       ${
         e.quoteTime
           ? `<small style="color:var(--muted); margin-left:4px;">
                (${new Date(e.quoteTime).toLocaleString()})
              </small>`
           : ''
       }
     </span>`
  : '';

  const roi = e.isTrade && e.trade?.entry && e.currentPrice
    ? calcROI(e.trade.entry, e.currentPrice)
    : '';

  return `
  <div class="card" id="card-${e.id}">
    <div class="card-header">
      <div>
        <span class="card-title" onclick="selectTree('${e.tickerCode}')">
  ${e.tickerName}(${e.tickerCode}) <small>#${seq}</small>
</span>
${ageBadge}
${alarmBadge}
${e.sector ? `
  <span class="meta-pill sector"
      onclick="searchDeskByMeta('${e.sector}')"
      style="cursor:pointer;">
  ğŸ· ${e.sector}
</span>
` : ''}

${e.tags ? e.tags.split(',').map(t => `
<span class="meta-pill tag"
      onclick="searchDeskByMeta('${t.trim()}')"
      style="cursor:pointer;">
  #${t.trim()}
</span>`).join('') : ''}

<span style="color:var(--muted); margin-left:10px;">${e.date}</span>

        ${price}
        ${e.isTrade && e.trade ? `
          <div class="trade-pill" style="margin-top:8px;">
            P ${fmtNum(e.trade.entry)} Â· T ${fmtNum(e.trade.target)} Â· S ${fmtNum(e.trade.stop)} Â· ${e.trade.status}
            ${roi ? ` Â· ${roi}` : ''}
          </div>` : ''}
  ${incomingBadge}
      </div>
      <div style="display:flex; gap:6px;">
        <button class="btn btn-ghost btn-mini" onclick="syncSingleQuote(${e.id})">ğŸ“Š ì‹œì„¸ ê°±ì‹ </button>
        <button class="btn btn-ghost btn-mini" onclick="openLinkModal(${e.id})">ğŸ”— ì—°ê²°</button>
        <button class="btn btn-ghost btn-mini" onclick="editEntry(${e.id})">âœï¸</button>
        <button class="btn btn-ghost btn-mini" style="color:var(--danger)" onclick="deleteEntry(${e.id})">ğŸ—‘</button>
      </div>
    </div>
    <div style="white-space:pre-wrap; font-weight:600; line-height:1.6; margin:0 0 12px;">${applyHighlight(e.content)}</div>
    ${urlPreview}
    ${e.invalidation ? `<div style="font-size:12px; color:var(--danger); background:#fff1f2; padding:8px; border-radius:6px;"><b>Risk:</b> ${e.invalidation}</div>` : ''}


${(e.images||[]).map((img, idx) => `
  <div style="
    display:flex;
    gap:12px;
    align-items:flex-start;
    margin:12px 0;
    padding-bottom:12px;
    border-bottom:${idx < e.images.length - 1 ? '1px dashed var(--line)' : 'none'};
  ">

    <!-- ğŸ“¸ ìº¡ì²˜ ì´ë¯¸ì§€ -->
    <img src="${img.src}"
     style="
       width:120px;
       height:80px;
       object-fit:cover;
       border-radius:8px;
       cursor:pointer;
       flex-shrink:0;
       box-shadow:0 2px 6px rgba(0,0,0,.1);
     "
     onclick="openImg(
       '${img.src.replace(/'/g,"\\'")}',
       '${(img.note||"").replace(/'/g,"\\'")}',
       ${idx},
       ${e.id}
     )">

    <!-- ğŸ“ ìº¡ì²˜ ë©”ëª¨ (ìš°ì¸¡, ëŒ“ê¸€ í†¤) -->
${img.note ? `
  <div style="
    flex:1;
    padding:10px 12px;
    background:#fffbea;
    border:1px solid #fde68a;
    border-radius:6px;
    font-size:12px;
    line-height:1.6;
    color:#713f12;
    white-space:pre-wrap;
    box-shadow:2px 2px 0 rgba(0,0,0,.05);
  ">
    ${escapeHtml(img.note)}
  </div>
` : ''}

  </div>
`).join('')}

    <div style="margin-top:12px; border-top:1px solid #f1f5f9; padding-top:10px; display:flex; flex-wrap:wrap; gap:6px;">

  
  ${outgoingLinks.length ? `
    <div style="font-size:11px; font-weight:900; color:var(--accent);">
      ğŸ”— ë‚´ê°€ ì—°ê²°í•œ ê°€ì„¤
    </div>
    ${outgoingLinks.map(lid => {
  const t = db.entries.find(x => x.id === lid);
  if (!t) return '';
  const tSeq = getTickerSeq(t);
  return `
    <div class="link-summary"
         style="display:flex; align-items:center; gap:6px;">
      <span onclick="jumpToNote(${lid})" style="flex:1; cursor:pointer;">
        â†³ [${t.tickerName}(${t.tickerCode}) #${tSeq}]
        ${getSummary(t.content)} (${t.date})
      </span>
<span
  onclick="removeEntryLink(${e.id}, ${lid})"
  style="
    font-size:9px;
    line-height:1;
    color:var(--muted);
    cursor:pointer;
    padding:2px 4px;
    margin-left:6px;
  "
  title="ì—°ê²° ì·¨ì†Œ"
>
  Ã—
</span>
    </div>`;
}).join('')}
  ` : ''}

  ${incomingLinks.length ? `
    <div style="font-size:11px; font-weight:900; color:#0369a1; margin-top:6px;">
      ğŸ” ë‚˜ë¥¼ ì°¸ì¡°í•œ ê°€ì„¤
    </div>
    ${incomingLinks.map(src => {
      const sSeq = getTickerSeq(src);
      return `
        <div class="link-summary"
             style="background:#ecfeff;color:#0369a1;"
             onclick="jumpToNote(${src.id})">
          â†² [${src.tickerName}(${src.tickerCode}) #${sSeq}]
          ${getSummary(src.content)} (${src.date})
        </div>`;
    }).join('')}
  ` : ''}

</div>

    <div class="comment-box">
      <div style="font-weight:900; font-size:12px; color:var(--muted); margin:6px 0;">ğŸ’¬ ëŒ“ê¸€</div>

${(e.comments||[]).map((c, idx) => {
  const isEditing =
    editingComment.entryId === e.id &&
    editingComment.index === idx;

  return `
  <div class="comment-item"
       style="display:flex; gap:8px; align-items:center;">

    ${isEditing ? `
      <textarea
        style="flex:1;"
        onkeydown="handleCommentKey(event, ${e.id}, ${idx})"
      >${escapeHtml(c.text)}</textarea>

      <button class="btn btn-mini btn-success"
        onclick="saveEditedComment(${e.id}, ${idx}, this)">
        âœ”
      </button>

      <button class="btn btn-mini btn-ghost"
        onclick="cancelEditComment()">
        ì·¨ì†Œ
      </button>
    ` : `
      <span style="flex:1;">
        â€¢ ${escapeHtml(c.text)}
        <small style="color:var(--muted);">
          ${new Date(c.ts).toLocaleDateString()}
        </small>
      </span>

      <button class="btn btn-mini btn-ghost"
        onclick="startEditComment(${e.id}, ${idx})">âœ</button>

      <button class="btn btn-mini btn-ghost"
        style="color:var(--danger);"
        onclick="deleteCommentInline(${e.id}, ${idx})">Ã—</button>
    `}
  </div>
  `;
}).join('')}

      <div class="comment-input">
        <input placeholder="ëŒ“ê¸€ ì…ë ¥ í›„ Enter" onkeydown="if(event.key==='Enter') addComment(${e.id}, this)">
        <button class="btn btn-primary btn-mini" onclick="addComment(${e.id}, this.previousElementSibling)">ì¶”ê°€</button>
      </div>
    </div>
  </div>`;
}

function renderTimeline() {
  const filtered = db.entries.filter(e => {

    // 1ï¸âƒ£ ì¢…ëª© íŠ¸ë¦¬ í•„í„°
    if (selectedTicker !== 'ALL' && e.tickerCode !== selectedTicker) {
      return false;
    }

    // 2ï¸âƒ£ Desk ê²€ìƒ‰ í•„í„° (realtime)
    if (deskSearchQuery) {

  const q = deskSearchQuery.replace(/^#/, ""); // ğŸ”‘ í•µì‹¬

      const haystack = [
        e.tickerName,
        e.tickerCode,
        e.sector || "",
        e.tags || "",
        e.content || "",
        e.invalidation || ""
      ].join(" ").toLowerCase();

     if (!haystack.includes(q)) {
        return false;
      }
    }

    return true;
  });

  document.getElementById('timeline').innerHTML =
    filtered.map(createCardHtml).join('');
}

function renderTree(q = "") {
  const counts = db.entries.reduce((acc, e) => {
    const code = e.tickerCode;
    if (!acc[code]) acc[code] = { name: e.tickerName, count: 0 };
    acc[code].count++;
    return acc;
  }, {});

  const list = document.getElementById('treeList');
  const query = (q || "").toUpperCase();
  let html = `<div class="tree-item ${selectedTicker==='ALL'?'active':''}" onclick="selectTree('ALL')"><span>ì „ì²´ë³´ê¸°</span><span>${db.entries.length}</span></div>`;

  Object.keys(counts).sort().forEach(code => {
    const { name, count } = counts[code];
    if (!q || code.includes(query) || name.toUpperCase().includes(query)) {
      html += `<div class="tree-item ${selectedTicker===code?'active':''}" onclick="selectTree('${code}')"><span>${name}</span><small>${count}</small></div>`;
    }
  });
  list.innerHTML = html;
}

function renderAll() {
  renderTree(document.getElementById('treeSearch').value || "");
  renderTimeline();
}

// ================================================
// ê¸°íƒ€ ê¸°ëŠ¥ë“¤ (jump, link, explorer, comment ë“±)
// ================================================


function startEditComment(entryId, idx) {
  editingComment = { entryId, index: idx };
  renderAll();
}

function cancelEditComment() {
  editingComment = { entryId: null, index: null };
  renderAll();
}

function saveEditedComment(entryId, idx, btnEl) {
  const textarea = btnEl.previousElementSibling;
  const text = textarea.value.trim();
  if (!text) return;

  const entry = db.entries.find(e => e.id === entryId);
  entry.comments[idx].text = text;
  entry.comments[idx].ts = Date.now();
entry.updatedAt = Date.now();

  editingComment = { entryId: null, index: null };
  persist(); renderAll();
}

function handleCommentKey(e, entryId, idx) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    saveEditedComment(entryId, idx, e.target.nextElementSibling);
  }
  if (e.key === 'Escape') {
    cancelEditComment();
  }
}

function deleteCommentInline(entryId, idx) {
  if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
  const entry = db.entries.find(e => e.id === entryId);
  entry.comments.splice(idx, 1);
entry.updatedAt = Date.now();
  persist(); renderAll(); updateSyncStatus();
}

function jumpToNote(id) {
  switchTab('desk');
  selectedTicker = "ALL";
  renderAll();
  setTimeout(() => {
    const el = document.getElementById(`card-${id}`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.boxShadow = "0 0 20px var(--warning)";
      setTimeout(() => el.style.boxShadow = "", 2000);
    }
  }, 300);
}

function openLinkModal(id) {
  linkingTargetId = id;
  document.getElementById('linkSearch').value = "";
  renderLinkOptions("");
  toggleModal('linkModal');
}

function renderLinkOptions(q) {
  const query = (q || "").trim().toLowerCase();
  const options = db.entries.filter(e =>
    e.id !== (linkingTargetId || editingId) &&
    (e.tickerName.toLowerCase().includes(query) ||
     e.tickerCode.toLowerCase().includes(query) ||
     (e.content||"").toLowerCase().includes(query))
  ).slice(0,15);

  document.getElementById('linkOptions').innerHTML = options.map(e => {
    const seq = getTickerSeq(e);
    return `
    <div style="padding:12px; border-bottom:1px solid #eee; cursor:pointer;" onclick="confirmLink(${e.id})">
      <div style="font-weight:900; color:var(--accent);">${e.tickerName}(${e.tickerCode}) #${seq} (${e.date})</div>
      <div style="font-size:12px; color:var(--muted);">${getSummary(e.content)}</div>
    </div>`;
  }).join('') || `<div style="padding:12px; color:var(--muted);">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
}

function confirmLink(targetId) {
  // ğŸ”¹ Report ì„¹ì…˜ ì¹´ë“œ ì¶”ê°€
  if (linkingTargetId === "__REPORT_SECTION__") {
    confirmReportSectionLink(targetId);
    return;
  }

  // ğŸ”¹ Report ê·¼ê±° ê°€ì„¤(entries)
  if (linkingTargetId === "__REPORT__" && reportDraft) {
    if (!reportDraft.entries.includes(targetId)) {
      reportDraft.entries.push(targetId);
      renderReportEntries();
    }
    toggleModal('linkModal');
    return;
  }

  // ğŸ”¹ ê¸°ì¡´ ê°€ì„¤ â†” ê°€ì„¤ ë§í¬
  if (linkingTargetId) {
    const entry = db.entries.find(x => x.id === linkingTargetId);
    if (!entry.links) entry.links = [];
    if (!entry.links.includes(targetId)) {
      entry.links.push(targetId);
      persist();
      renderAll();
    }
  }
  toggleModal('linkModal');
}


function renderExplorer() {
  const q = (document.getElementById('explorerGlobalSearch').value || "").toLowerCase();
  const hits = db.entries
    .filter(e => !q || [e.tickerName, e.tickerCode, e.sector||"", e.tags||"", e.content||""].some(v => v.toLowerCase().includes(q)))
    .slice(0,40);

  // ìƒë‹¨ ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
  document.getElementById('explorerSearchResults').innerHTML = hits.map(e => {
const incoming = getIncomingLinks(e.id);
    const seq = getTickerSeq(e);
    return `
    <div class="explorer-item" onclick="jumpToNote(${e.id})">
      <div style="display:flex; justify-content:space-between;">
        <span style="font-weight:900; color:var(--accent);">${e.tickerName}(${e.tickerCode}) #${seq}</span>
        <span style="font-size:11px; color:var(--muted);">${e.date}</span>
      </div>
      <div style="margin-top:4px;">
        ${e.sector ? `
  <span class="meta-pill sector"
        onclick="event.stopPropagation(); searchByMeta('sector','${e.sector}')"
        style="cursor:pointer;">
    ğŸ· ${e.sector}
  </span>
` : ''}

${e.tags ? e.tags.split(',').map(t => `
  <span class="meta-pill tag"
        onclick="event.stopPropagation(); searchByMeta('tag','${t.trim()}')"
        style="cursor:pointer;">
    #${t.trim()}
  </span>
`).join('') : ''}
      </div>
      <div style="font-size:13px; margin-top:4px;">${applyHighlight(getSummary(e.content))}</div>


<!-- ğŸ“¸ ìº¡ì³ ë¯¸ë¦¬ë³´ê¸° -->
${e.images && e.images.length ? `
<div
  style="margin-top:8px; display:inline-block;"
  onclick="event.stopPropagation(); openImg(
    '${e.images[0].src.replace(/'/g,"\\'")}',
    '${(e.images[0].note||"").replace(/'/g,"\\'")}',
    0,
    ${e.id}
  )">
  <img src="${e.images[0].src}"
       style="
         width:120px;
         height:80px;
         object-fit:cover;
         border-radius:8px;
         cursor:pointer;
         box-shadow:0 2px 6px rgba(0,0,0,.12);
       ">
</div>
` : ''}

<!-- ğŸ”— / ğŸ’¬ ìƒíƒœ -->
<div style="
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
  display:flex;
  gap:10px;
  align-items:center;
">
<!-- ğŸ”— ì—°ê²°ëœ ê°€ì„¤ (Alarm Queueì™€ ë™ì¼) -->
${(e.links || []).length ? `
<div style="
  margin-top:8px;
  font-size:11px;
  padding-top:6px;
  border-top:1px dashed var(--line);
">
  <b style="color:var(--accent);">ğŸ”— ì—°ê²°ëœ ê°€ì„¤</b>
  ${(e.links || []).slice(0,2).map(lid => {
    const t = db.entries.find(x => x.id === lid);
    if (!t) return '';
    return `
      <div class="link-summary"
           style="margin-top:4px;"
           onclick="event.stopPropagation(); jumpToNote(${t.id})">
        â†³ ${t.tickerName}(${t.tickerCode}) Â· ${getSummary(t.content)}
      </div>
    `;
  }).join('')}
</div>
` : ''}

${incoming.length ? `
<div style="
  margin-top:8px;
  font-size:11px;
  padding-top:6px;
  border-top:1px dashed var(--line);
">
  <b style="color:#0369a1;">ğŸ” ë‚˜ë¥¼ ì°¸ì¡°í•œ ê°€ì„¤</b>
  ${incoming.slice(0,2).map(src => `
    <div class="link-summary"
         style="margin-top:4px; background:#ecfeff; color:#0369a1;"
         onclick="event.stopPropagation(); jumpToNote(${src.id})">
      â†² ${src.tickerName}(${src.tickerCode}) Â· ${getSummary(src.content)}
    </div>
  `).join('')}
</div>
` : ''}

</div>

<!-- ğŸ’¬ ëŒ“ê¸€ (Explorer í•˜ë‹¨ ê³ ì •) -->
${(e.comments || []).length ? `
<div style="
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed var(--line);
  font-size:11px;
  color:var(--muted);
">
  <b>ğŸ’¬ ëŒ“ê¸€</b>

  ${(e.comments || []).slice(-2).map(c => `
    <div style="
      margin-top:6px;
      line-height:1.5;
      white-space:normal;
    ">
      â€¢ ${escapeHtml(c.text)}
    </div>
  `).join('')}


</div>
` : ''}

      
    </div>`;
  }).join('') || `<div style="padding:12px; color:var(--muted);">ê²°ê³¼ ì—†ìŒ</div>`;

  // ì§€ì‹ ë„¤íŠ¸ì›Œí¬(ì—°ê²° ìŒ) ì¶”ì¶œ ë° ë Œë”ë§
  const pairs = [];
  db.entries.forEach(src => (src.links||[]).forEach(tid => {
    const tgt = db.entries.find(x => x.id === tid);
    if (tgt) pairs.push({src, tgt});
  }));

  document.getElementById('knowledgeLinkList').innerHTML = pairs.slice(0,40).map(p => {
    const sSeq = getTickerSeq(p.src);
    const tSeq = getTickerSeq(p.tgt);
    return `
    <div class="explorer-item" style="border-left:4px solid var(--success);">
      <div onclick="jumpToNote(${p.src.id})" style="font-weight:800; color:var(--accent); font-size:12px;">
        [ì›ë³¸] ${p.src.tickerName}(${p.src.tickerCode}) #${sSeq}: ${escapeHtml(getSummary(p.src.content))}
      </div>
      <div style="margin:6px 0; color:var(--muted); font-size:10px; padding-left:10px;">â–¼ ì—°ê²°ë¨</div>
      <div onclick="jumpToNote(${p.tgt.id})" style="font-weight:800; color:var(--success); font-size:12px;">
        [ì—°ê²°] ${p.tgt.tickerName}(${p.tgt.tickerCode}) #${tSeq}: ${escapeHtml(getSummary(p.tgt.content))}
      </div>
    </div>`;
  }).join('') || `<div style="padding:12px; color:var(--muted);">ì—°ê²°ëœ ë¦¬í¬íŠ¸ ì—†ìŒ</div>`;
}


function addComment(id, inputEl) {
  const text = (inputEl.value || "").trim();
  if (!text) return;
  const entry = db.entries.find(x => x.id === id);
  if (!entry) return;
  if (!entry.comments) entry.comments = [];
  entry.comments.push({ text, ts: Date.now() });
entry.updatedAt = Date.now(); //
  inputEl.value = "";
  persist();
  renderAll();
  updateSyncStatus();
}

function escapeHtml(str) {
  return String(str||"")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// ================================================
// CRUD & Persist
// ================================================
function saveEntry() {
  const code = document.getElementById('tickerCode').value.trim().toUpperCase();
  const content = document.getElementById('content').value.trim();
  if (!code || !content) return alert("í‹°ì»¤ì™€ ê°€ì„¤ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const isTrade = document.getElementById('isTrade').checked;

  // ğŸ”” ì•ŒëŒ ê°’ì€ entry ê°ì²´ ë§Œë“¤ê¸° 'ì „ì—' ê³„ì‚°
  const isAlarm = !!document.getElementById('isAlarm')?.checked;

  const alarmDate =
    document.getElementById('alarmDate')?.value ||
    (
      document.getElementById('alarmAfter')?.value
        ? new Date(Date.now() + Number(document.getElementById('alarmAfter').value) * 86400000)
            .toISOString().split('T')[0]
        : null
    );

  const alarm = (isAlarm && alarmDate)
    ? { date: alarmDate, done: false }
    : null;

  const prev = editingId ? db.entries.find(x => x.id === editingId) : null;

  const entry = {
    id: editingId || Date.now(),
    tickerName: document.getElementById('tickerName').value.trim() || code,
    tickerCode: code,
    sector: document.getElementById('sector').value.trim(),
    date: document.getElementById('date').value,
    tags: document.getElementById('tags').value.trim(),
    content,
    invalidation: document.getElementById('invalidation').value.trim(),
    links: [...draftLinks],
    images: [...draftImages],

    comments: editingId ? (prev?.comments || []) : [],
    updatedAt: Date.now(),
    createdAt: editingId ? (prev?.createdAt || Date.now()) : Date.now(),

    isTrade,
    trade: isTrade ? {
      entry: document.getElementById('entry').value,
      target: document.getElementById('target').value,
      stop: document.getElementById('stop').value,
      status: document.getElementById('status').value
    } : null,

    // âœ… ì•ŒëŒ ì €ì¥ (í•µì‹¬)
    isAlarm,
    alarm,

    // ê¸°ì¡´ ì‹œì„¸ ìœ ì§€
    currentPrice: editingId ? (prev?.currentPrice ?? null) : null
  };

  if (editingId) {
    db.entries = db.entries.map(x => x.id === editingId ? entry : x);
  } else {
    db.entries.unshift(entry);
  }

  persist();
  clearForm();
  renderAll();
  updateSyncStatus();
}
function editEntry(id) {
  const e = db.entries.find(x => x.id === id);
  if (!e) return;

  editingId = id;
  document.getElementById('tickerName').value = e.tickerName || "";
  document.getElementById('tickerCode').value = e.tickerCode || "";
  document.getElementById('sector').value = e.sector || "";
  document.getElementById('date').value = e.date || "";
  document.getElementById('tags').value = e.tags || "";
  document.getElementById('content').value = e.content || "";
  document.getElementById('invalidation').value = e.invalidation || "";

  draftLinks = [...(e.links || [])];
  draftImages = [...(e.images || [])];

  document.getElementById('isTrade').checked = !!e.isTrade;
  toggleTradeFields(!!e.isTrade);

  if (e.isTrade && e.trade) {
    document.getElementById('entry').value = e.trade.entry || "";
    document.getElementById('target').value = e.trade.target || "";
    document.getElementById('stop').value = e.trade.stop || "";
    document.getElementById('status').value = e.trade.status || "ACTIVE";
  } else {
    document.getElementById('entry').value = "";
    document.getElementById('target').value = "";
    document.getElementById('stop').value = "";
    document.getElementById('status').value = "ACTIVE";
  }

// ğŸ”” ì•ŒëŒ ë³µì›
document.getElementById('isAlarm').checked = !!e.isAlarm;
toggleAlarmFields(!!e.isAlarm);

if (e.isAlarm && e.alarm) {
  document.getElementById('alarmDate').value = e.alarm.date || "";
  document.getElementById('alarmAfter').value = "";
} else {
  document.getElementById('alarmDate').value = "";
  document.getElementById('alarmAfter').value = "";
}

  renderCaptureBoard();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteEntry(id) {
  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  db.entries = db.entries.filter(x => x.id !== id);

  // ğŸ”¥ ë°ì´í„° êµ¬ì¡° ë³€ê²½ â†’ ë²„ì „ ê°±ì‹ 
  db.meta._lastStructuralChange = Date.now(); // ë˜ëŠ” metaì— ê¸°ë¡
  persist();
  updateSyncStatus();
  renderAll();
}

function persist() {
  localStorage.setItem('rd_v10_5', JSON.stringify(db));
}

function clearForm() {
  ['tickerName','tickerCode','sector','tags','content','invalidation','entry','target','stop'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  document.getElementById('status').value = "ACTIVE";
  document.getElementById('isTrade').checked = false;
  toggleTradeFields(false);
  editingId = null;
  draftLinks = [];
  draftImages = [];
  renderCaptureBoard();

document.getElementById('isAlarm').checked = false;
toggleAlarmFields(false);
document.getElementById('alarmDate').value = "";
document.getElementById('alarmAfter').value = "";

}

// ================================================
// íƒ­ & íŠ¸ë¦¬ & ëª¨ë‹¬
// ================================================
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`content-${tab}`).classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');

if (tab === 'explorer') {
  renderExplorer();
  renderReviewQueue();
renderAlarmQueue();
}

  if (tab === 'report') {
  renderReportList();
  updateReportEditorState();
}
} // âœ… ì´ ì¤‘ê´„í˜¸ ë°˜ë“œì‹œ í•„ìš”

function selectTree(ticker) {
  selectedTicker = ticker;
  renderAll();
}

function toggleModal(id) {
  const m = document.getElementById(id);
  m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
}



// ================================================
// 1. ë°ì´í„°ì˜ ì‹¤ì œ ìµœì‹  ìˆ˜ì • ì‹œê° ê³„ì‚° (Data Version)
// ================================================
function getLocalDataLastTs() {
  const entryTs = db.entries.map(e => Number(e.updatedAt || e.createdAt || 0));
  const reportTs = (db.reports || []).map(r => Number(r.updatedAt || r.createdAt || 0));
  const allTs = [...entryTs, ...reportTs].filter(t => t > 0);
  
  return allTs.length === 0 ? 0 : Math.max(...allTs);
}

// ================================================
// 2. ë™ê¸°í™” ëª¨ë‹ˆí„° ì—…ë°ì´íŠ¸ (Alpha Blotter ë¡œì§ ì´ì‹)
// ================================================
function updateSyncStatus() {
  const localTs = Math.floor(getLocalDataLastTs());
  const imp = Math.floor(db.meta.lastImportAt || 0);
  const exp = Math.floor(db.meta.lastExportAt || 0);
  const qsync = Math.floor(db.meta.lastQuoteSyncAt || 0);

  // í™”ë©´ í‘œì‹œ
  document.getElementById('localLastTs').textContent =
    localTs > 0 ? fmtDateTime(localTs) : "-";
  document.getElementById('importLastTs').textContent =
    imp > 0 ? fmtDateTime(imp) : "-";
  document.getElementById('exportLastTs').textContent =
    exp > 0 ? fmtDateTime(exp) : "-";
  document.getElementById('quoteLastTs').textContent =
    qsync > 0 ? fmtDateTime(qsync) : "-";

  const sentinel = document.getElementById('syncSentinel');
  sentinel.classList.remove('sync-warn', 'sync-danger');

  if (!localTs) return;

  // âœ… 1ï¸âƒ£ ì •ìƒ: import ë˜ëŠ” export ì¤‘ í•˜ë‚˜ë¼ë„ localê³¼ ë™ì¼
  if (localTs === imp || localTs === exp) {
    return; // ì •ìƒ ìƒíƒœ â†’ ì•„ë¬´ í´ë˜ìŠ¤ë„ ì•ˆ ë¶™ì„
  }

  // ğŸš¨ 2ï¸âƒ£ ìœ„í—˜: import ë°ì´í„°ê°€ localë³´ë‹¤ ìµœì‹ 
  if (imp > localTs) {
    sentinel.classList.add('sync-danger');
    return;
  }

  // âš ï¸ 3ï¸âƒ£ ê²½ê³ : localì´ exportë³´ë‹¤ ìµœì‹ 
  if (localTs > exp) {
    sentinel.classList.add('sync-warn');
  }
}

function resetAll() {
  if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  db = {
  entries: [],
  reports: [],
  meta: { lastImportAt:0, lastExportAt:0, lastQuoteSyncAt:0 }
};
  persist();
  renderAll();
  updateSyncStatus();
}

function openImg(src, note = "", idx = null, entryId = null) {
  const imgEl = document.getElementById('lbImg');
  const wrapEl = document.getElementById('lbNoteWrap');
  const inputEl = document.getElementById('lbNoteInput');

  imgEl.onload = () => {
    resizePenCanvas();
    clearPenCanvas();
  };
  imgEl.src = src;

  lightboxImageIndex = idx;
  lightboxMode = entryId ? "entry" : "draft";
  lightboxEntryId = entryId || null;

  wrapEl.style.display = idx !== null ? 'flex' : 'none';
  inputEl.value = note || "";

  document.getElementById('lightbox').style.display = 'flex';
}

function resizePenCanvas() {
  const img = document.getElementById('lbImg');
  const canvas = document.getElementById('penCanvas');
  if (!img || !canvas) return;

  canvas.width  = img.clientWidth;
  canvas.height = img.clientHeight;

  canvas.style.left = img.offsetLeft + 'px';
  canvas.style.top  = img.offsetTop + 'px';
}

// ================================================
// ìº¡ì²˜ ë³´ë“œ (Ctrl+V)
// ================================================
function renderCaptureBoard() {
  const board = document.getElementById('captureBoard');
  board.innerHTML = "";
  for (let i = 0; i < 3; i++) {
    const img = draftImages[i];
    if (img) {
      board.innerHTML += `
      <div class="cap-slot">
        <img src="${img.src}" onclick="openImg(
  '${img.src.replace(/'/g,"\\'")}',
  '${(img.note||"").replace(/'/g,"\\'")}',
  ${i}
)">
        <button class="cap-remove" onclick="draftImages.splice(${i},1); renderCaptureBoard()">Ã—</button>
        <textarea class="cap-note" placeholder="ìº¡ì²˜ ë©”ëª¨" oninput="draftImages[${i}].note=this.value">${escapeHtml(img.note||"")}</textarea>
      </div>`;
    } else {
      board.innerHTML += `<div class="cap-slot" style="align-items:center;justify-content:center;"><span style="font-size:10px;color:var(--line);">ğŸ“¸ Ctrl+V</span></div>`;
    }
  }
}

document.addEventListener('paste', e => {
  if (['TEXTAREA','INPUT'].includes(document.activeElement?.tagName)) return;
  const file = [...e.clipboardData.items].find(item => item.type.startsWith('image/'));
  if (file && draftImages.length < 3) {
    const reader = new FileReader();
    reader.onload = ev => {
      draftImages.push({ src: ev.target.result, note: "" });
      renderCaptureBoard();
    };
    reader.readAsDataURL(file.getAsFile());
  }
});




document.addEventListener('keydown', e => {



/* ==========================
   Ctrl + Alt + Q (ì „ì²´ ì‹œì„¸ ë™ê¸°í™”)
========================== */

if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'q') {
  syncQuotes();
  e.preventDefault();
  return;
}



/* ==========================
   Ctrl + Shift + Q (í˜„ì¬ ì‹œì„¸ ê°±ì‹ )
========================== */

if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'q') {

  const activeTab =
    document.querySelector('.tab-content.active')?.id;

  // 1ï¸âƒ£ Desk íƒ­
  if (activeTab === "content-desk") {

    const code =
      document.getElementById('tickerCode')?.value.trim();

    if (!code) {
      alert("ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    fetchQuote(code).then(quote => {
      if (!quote) return alert("ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨");

      alert(
        `í˜„ì¬ê°€: ${fmtNum(quote.price)}\n` +
        `ê¸°ì¤€ì‹œê°: ${new Date(quote.time).toLocaleString()}`
      );
    });

    e.preventDefault();
    return;
  }

  // 2ï¸âƒ£ Report íƒ­
  if (activeTab === "content-report") {

    refreshReportPrice();
    e.preventDefault();
    return;
  }
}


  const el = document.activeElement;
  const isTextarea = el && el.tagName === "TEXTAREA";

  /* ==========================
     1ï¸âƒ£ ê²€ìƒ‰ì°½ ì´ë™ (Ctrl + Shift + F)
  ========================== */

  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'f') {

    const activeTab = document.querySelector('.tab-content.active')?.id;

    if (activeTab === "content-desk") {
      const input = document.getElementById('treeSearch');
      input?.focus();
      input?.select();
    }

    if (activeTab === "content-explorer") {
      const input = document.getElementById('explorerGlobalSearch');
      input?.focus();
      input?.select();
    }

if (activeTab === "content-report") {
  const input = document.getElementById('reportSearch');
  input?.focus();
  input?.select();
}


    e.preventDefault();
    return;
  }

  /* ==========================
     2ï¸âƒ£ ì½”ë“œ ì¡°íšŒ (Ctrl + Shift + C)
  ========================== */

  /* ==========================
   Ctrl + Shift + C (ì½”ë“œ ì¡°íšŒ)
========================== */

if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'c') {

  const activeTab =
    document.querySelector('.tab-content.active')?.id;

  if (activeTab === "content-desk") {
    webMapTicker();
    e.preventDefault();
    return;
  }

  if (activeTab === "content-report") {
    webMapTickerReport();
    e.preventDefault();
    return;
  }

  // Explorer / MonitorëŠ” ë¬´ì‹œ
}


  /* ==========================
     3ï¸âƒ£ íƒ­ ì´ë™ (Ctrl + Alt)
  ========================== */

  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'd') {
    switchTab('desk');
    e.preventDefault();
    return;
  }

  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'm') {
    switchTab('monitor');
    e.preventDefault();
    return;
  }

  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'e') {
    switchTab('explorer');
    e.preventDefault();
    return;
  }

  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'r') {
    switchTab('report');
    e.preventDefault();
    return;
  }

  /* ==========================
     4ï¸âƒ£ ì¹´ë“œ ì €ì¥ (Ctrl + Enter)
  ========================== */

  /* ==========================
   Ctrl + Enter (íƒ­ë³„ ì €ì¥)
========================== */

if (e.ctrlKey && e.key === 'Enter') {

  const activeTab =
    document.querySelector('.tab-content.active')?.id;

  // 1ï¸âƒ£ Desk íƒ­
  if (activeTab === "content-desk") {
    saveEntry();
    e.preventDefault();
    return;
  }

  // 2ï¸âƒ£ Report íƒ­
  if (activeTab === "content-report") {
    saveReport();
    e.preventDefault();
    return;
  }

  // 3ï¸âƒ£ ê·¸ ì™¸ íƒ­ â†’ ë¬´ì‹œ
}


  /* ==========================
     5ï¸âƒ£ Markdown ë‹¨ì¶•í‚¤
  ========================== */

  if (!isTextarea) return;

  function wrapSelection(before, after = before) {
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const selected = el.value.substring(start, end);

    el.value =
      el.value.substring(0, start) +
      before + selected + after +
      el.value.substring(end);

    el.focus();
    el.selectionStart = start + before.length;
    el.selectionEnd = end + before.length;
  }

  // Bold
  if (e.ctrlKey && e.key.toLowerCase() === 'b') {
    wrapSelection("**");
    e.preventDefault();
  }

  // Italic
  if (e.ctrlKey && e.key.toLowerCase() === 'i') {
    wrapSelection("*");
    e.preventDefault();
  }

  // Underline
  if (e.ctrlKey && e.key.toLowerCase() === 'u') {
    wrapSelection("__");
    e.preventDefault();
  }

  // Highlight
  if (e.ctrlKey && e.key.toLowerCase() === 'h') {
    wrapSelection("==");
    e.preventDefault();
  }

});



function handleImageUpload(files){
  [...files]
    .slice(0, 3 - draftImages.length)
    .forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        draftImages.push({ src: e.target.result, note: "" });
        renderCaptureBoard();
      };
      reader.readAsDataURL(file);
    });
}



// ================================================
// ë‚´ë³´ë‚´ê¸° / ê°€ì ¸ì˜¤ê¸°
// ================================================
function exportData() {
  // ë²„íŠ¼ ëˆ„ë¥¸ ì‹œê°(Date.now())ì´ ì•„ë‹ˆë¼, í˜„ì¬ ë°ì´í„°ì˜ 'ë²„ì „'ì„ ê¸°ë¡
  const dataVersion = getLocalDataLastTs();
  
  db.meta.lastExportAt = dataVersion;
  persist(); // ê¸°ë¡ í›„ ì €ì¥

  const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `research_desk_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);

  updateSyncStatus();
}

// ================================================
// 4. ê°€ì ¸ì˜¤ê¸° (Import) - ì‹œê° ë™ê¸°í™” êµì •
// ================================================
function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const importedDb = JSON.parse(reader.result);
      
      // íŒŒì¼ ë‚´ ë°ì´í„° ì‹œê° ì „ìˆ˜ì¡°ì‚¬
      const entryTs = (importedDb.entries || []).map(e => e.updatedAt || e.createdAt || 0);
      const reportTs = (importedDb.reports || []).map(r => r.updatedAt || r.createdAt || 0);
      const fileDataVersion = Math.max(0, ...entryTs, ...reportTs);

      // ê°€ì ¸ì˜¨ ë°ì´í„°ì˜ ë²„ì „ì„ metaì— ì£¼ì…
      if (!importedDb.meta) importedDb.meta = {};
      importedDb.meta.lastImportAt = fileDataVersion;
      importedDb.meta.lastExportAt = fileDataVersion; // ê°€ì ¸ì˜¨ ì§í›„ì—” ë‚´ë³´ë‚¸ ìƒíƒœì™€ ê°™ìŒ

      db = importedDb;
      persist();
      renderAll();
      updateSyncStatus();
      alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.");
    } catch (err) {
      alert("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  };
  reader.readAsText(file);
}



async function webMapTicker() {
  const btn = document.getElementById('lookupBtn');
  const nameEl = document.getElementById('tickerName');
  const codeEl = document.getElementById('tickerCode');

  const q = nameEl.value.trim() || codeEl.value.trim();
  if (!q) return;

  btn.disabled = true;
  btn.textContent = "ì¡°íšŒ ì¤‘...";

  try {
    const url = `https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}&quotesCount=10`;
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data.quotes?.length) {
      alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // 1ï¸âƒ£ í›„ë³´ ì„ íƒ
    let best = data.quotes[0];
    if (/^[a-zA-Z]+$/.test(q)) {
      best = data.quotes.find(qt => !qt.symbol?.endsWith('.KS') && !qt.symbol?.endsWith('.KQ')) || best;
    } else {
      best = data.quotes.find(qt => qt.symbol?.endsWith('.KS') || qt.symbol?.endsWith('.KQ')) || best;
    }

    // 2ï¸âƒ£ Yahoo ì›ë³¸ symbol ê¸°ì¤€ìœ¼ë¡œ êµ­ë‚´/í•´ì™¸ íŒë‹¨
    const rawSymbol = best.symbol || "";
    const isDomesticResult = /\.KS$|\.KQ$/.test(rawSymbol);

    // 3ï¸âƒ£ ì¢…ëª©ì½”ë“œëŠ” í•­ìƒ ì„¸íŒ… (í‘œì‹œìš©ìœ¼ë¡œë§Œ suffix ì œê±°)
    codeEl.value = rawSymbol.replace(/\.KS|\.KQ$/, '') || q;

    // 4ï¸âƒ£ ì¢…ëª©ëª…ì€ í•´ì™¸ ì¢…ëª©ì¼ ë•Œë§Œ ë®ì–´ì“°ê¸°
    if (!isDomesticResult) {
      nameEl.value = best.shortname || best.longname || q;
    }

  } catch (err) {
    console.error(err);
    alert("ì¢…ëª© ì¡°íšŒ ì‹¤íŒ¨\n" + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "ì½”ë“œ ì¡°íšŒ";
  }
}


async function webMapTickerReport() {

  const nameEl = document.getElementById('reportTickerName');
  const codeEl = document.getElementById('reportTickerCode');

  const q = nameEl.value.trim() || codeEl.value.trim();
  if (!q) return;

  try {

    const url =
      `https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}&quotesCount=10`;

    const res = await fetch(
      `https://corsproxy.io/?${encodeURIComponent(url)}`
    );

    if (!res.ok) throw new Error();

    const data = await res.json();

    if (!data.quotes?.length) {
      alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    let best = data.quotes[0];

    // êµ­ë‚´/í•´ì™¸ ë¶„ê¸°
    if (/^[a-zA-Z]+$/.test(q)) {
      best = data.quotes.find(qt =>
        !qt.symbol?.endsWith('.KS') &&
        !qt.symbol?.endsWith('.KQ')
      ) || best;
    } else {
      best = data.quotes.find(qt =>
        qt.symbol?.endsWith('.KS') ||
        qt.symbol?.endsWith('.KQ')
      ) || best;
    }

    const rawSymbol = best.symbol || "";

    codeEl.value = rawSymbol.replace(/\.KS|\.KQ$/, '');

    if (!/\.KS$|\.KQ$/.test(rawSymbol)) {
      nameEl.value =
        best.shortname ||
        best.longname ||
        q;
    }

  } catch {
    alert("ì¢…ëª© ì¡°íšŒ ì‹¤íŒ¨");
  }
}



async function fetchQuote(ticker) {

  async function tryFetch(symbol) {
    try {

      const url =
        `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=1m&range=1d`;

      // ğŸ”¥ ìºì‹œ ë°©ì§€
      const proxy =
        `https://corsproxy.io/?${encodeURIComponent(url)}&t=${Date.now()}`;

      const res = await fetch(proxy, { cache: "no-store" });
      if (!res.ok) return null;

      const data = await res.json();
      const result = data?.chart?.result?.[0];

      if (!result?.timestamp?.length) return null;

      const timestamps = result.timestamp;
      const closes =
        result.indicators?.quote?.[0]?.close;

      if (!closes?.length) return null;

      // ğŸ”¥ ê°€ì¥ ë§ˆì§€ë§‰ ìœ íš¨ ê°€ê²© ì°¾ê¸°
      let lastIndex = closes.length - 1;
      while (lastIndex >= 0 && closes[lastIndex] == null) {
        lastIndex--;
      }

      if (lastIndex < 0) return null;

      const price = closes[lastIndex];
      const time = timestamps[lastIndex] * 1000;

      if (typeof price !== "number" || price <= 0) return null;

      return {
        price: price,
        time: time
      };

    } catch {
      return null;
    }
  }

  try {

    // ìˆ«ì ì½”ë“œ = êµ­ë‚´ ì¢…ëª©
    if (/^\d+$/.test(ticker)) {

      let quote = await tryFetch(ticker + ".KS");
      if (quote !== null) return quote;

      quote = await tryFetch(ticker + ".KQ");
      if (quote !== null) return quote;

      return null;
    }

    // í™•ì¥ì í¬í•¨
    if (ticker.includes(".")) {
      return await tryFetch(ticker);
    }

    // í•´ì™¸ ì¢…ëª©
    return await tryFetch(ticker);

  } catch (err) {
    console.error(`ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨ (${ticker}):`, err);
    return null;
  }
}

async function syncQuotes() {
  if (!db.entries.length) return alert("ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

  const tickers = [...new Set(db.entries.map(e => e.tickerCode))];
  let updated = 0;

  for (const ticker of tickers) {

    const quote = await fetchQuote(ticker);

    if (quote !== null) {
      db.entries.forEach(e => {
        if (e.tickerCode === ticker) {
          e.currentPrice = quote.price;
          e.quoteTime = quote.time;   // ğŸ”¥ ì‹œì„¸ ê¸°ì¤€ ì‹œê° ì €ì¥
        }
      });
      updated++;
    }
  }

  if (updated > 0) {
    db.meta.lastQuoteSyncAt = Date.now();
    persist();
    renderAll();
    updateSyncStatus();
    alert(`ì´ ${updated}ê°œ ì¢…ëª© ì‹œì„¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
  } else {
    alert("ì‹œì„¸ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ë˜ëŠ” API ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
}

async function syncSingleQuote(id) {

  const entry = db.entries.find(e => e.id === id);
  if (!entry) return;

  const quote = await fetchQuote(entry.tickerCode);

  if (quote !== null) {

    entry.currentPrice = quote.price;
    entry.quoteTime = quote.time;   // ğŸ”¥ ì‹œì„¸ ê¸°ì¤€ ì‹œê° ì €ì¥
    entry.updatedAt = Date.now();

    persist();
    renderAll();
    updateSyncStatus();

    alert(
      `${entry.tickerName}(${entry.tickerCode}) ì‹œì„¸ ì—…ë°ì´íŠ¸\n\n` +
      `í˜„ì¬ê°€: ${fmtNum(quote.price)}\n` +
      `ê¸°ì¤€ì‹œê°: ${new Date(quote.time).toLocaleString()}`
    );

  } else {
    alert("ì‹œì„¸ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
}


function getIncomingLinks(id) {
  return db.entries.filter(e => (e.links||[]).includes(id));
}

/* ================================
   ë¼ì´íŠ¸ë°•ìŠ¤ ë©”ëª¨ ë‹¨ì¶•í‚¤ (Ctrl+Enter)
================================ */
document.getElementById('lbNoteInput')
  ?.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') {
      saveLightboxNote();
      e.preventDefault();
    }
  });

function saveLightboxNote() {
  if (lightboxImageIndex === null) return;
  const note = document.getElementById('lbNoteInput').value || "";

  if (lightboxMode === "draft") {
    if (draftImages[lightboxImageIndex]) {
      draftImages[lightboxImageIndex].note = note;
    }
    renderCaptureBoard();
  }

  if (lightboxMode === "entry" && lightboxEntryId) {
    const entry = db.entries.find(e => e.id === lightboxEntryId);
    if (entry?.images?.[lightboxImageIndex]) {
      entry.images[lightboxImageIndex].note = note;
      entry.updatedAt = Date.now();
      persist();
      renderAll();
    }
  }
}



/* ================================
   Pen & Mouse Drawing (ìµœì¢…ë³¸)
================================ */
const penCanvas = document.getElementById('penCanvas');
const penCtx = penCanvas.getContext('2d');

let drawing = false;

penCtx.strokeStyle = '#ef4444';
penCtx.lineWidth = 2;
penCtx.lineCap = 'round';

function getPos(e) {
  const rect = penCanvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

penCanvas.addEventListener('pointerdown', e => {
  if (e.pointerType === 'touch') return; // ì†ê°€ë½ ì œì™¸
  drawing = true;
  const { x, y } = getPos(e);
  penCtx.beginPath();
  penCtx.moveTo(x, y);
});

penCanvas.addEventListener('pointermove', e => {
  if (!drawing) return;
  const { x, y } = getPos(e);
  penCtx.lineTo(x, y);
  penCtx.stroke();
});

['pointerup','pointerleave','pointercancel']
  .forEach(ev =>
    penCanvas.addEventListener(ev, () => drawing = false)
  );

function clearPenCanvas() {
  penCtx.clearRect(0, 0, penCanvas.width, penCanvas.height);
}

function savePenToImage() {
  const img = document.getElementById('lbImg');
  const canvas = document.getElementById('penCanvas');

  const merged = document.createElement('canvas');
  merged.width = canvas.width;
  merged.height = canvas.height;

  const mctx = merged.getContext('2d');
  mctx.drawImage(img, 0, 0, merged.width, merged.height);
  mctx.drawImage(canvas, 0, 0);

  const dataURL = merged.toDataURL();

  // draft ì´ë¯¸ì§€ ì €ì¥
  if (lightboxMode === "draft" && lightboxImageIndex !== null) {
    draftImages[lightboxImageIndex].src = dataURL;
    draftImages[lightboxImageIndex].note += "\n[íœ ë©”ëª¨ í¬í•¨]";
    renderCaptureBoard();
  }

  // entry ì´ë¯¸ì§€ ì €ì¥
  if (lightboxMode === "entry" && lightboxEntryId) {
    const entry = db.entries.find(e => e.id === lightboxEntryId);
    if (entry?.images?.[lightboxImageIndex]) {
      entry.images[lightboxImageIndex].src = dataURL;
      entry.updatedAt = Date.now();
      persist();
      renderAll();
    }
  }

  clearPenCanvas();
}


function getPlatformLabel(url) {
  try {
    if (url.includes("n.news.naver.com")) return "ğŸŸ¢ NAVER NEWS";
    if (url.includes("youtube.com") || url.includes("youtu.be")) return "ğŸ”´ YOUTUBE";
    if (url.includes("dart.fss.or.kr")) return "ğŸ›ï¸ DART";
    return new URL(url).hostname;
  } catch {
    return "LINK";
  }
}

function newReport() {
  reportDraft = {
    id: Date.now(),
    title: "",
    opinion: "",
    reportDate: new Date().toISOString().slice(0,10),

    tickerName: "",   // âœ… ì¶”ê°€
    tickerCode: "",   // âœ… ì¶”ê°€
    price: null,

    createdAt: Date.now(),
    updatedAt: Date.now(),
    sections: {
  summary: { text:"", cards:[] },
  macro: { text:"", cards:[] },
  sector: { text:"", cards:[] },
  conclusion: { text:"", cards:[] }
},
entries: [] // â† 1ë²ˆ(ê·¼ê±° ê°€ì„¤) ì „ìš©ìœ¼ë¡œ ìœ ì§€

  };
  editingReportId = null;
  bindReportToUI();
  updateReportEditorState(); // âœ… ì¶”ê°€
}


function openReport(id) {
  const r = db.reports.find(x => x.id == id);
  if (!r) return;

  reportDraft = JSON.parse(JSON.stringify(r));
  editingReportId = r.id;

  // êµ¬ë²„ì „ í˜¸í™˜ ì²˜ë¦¬(ì§€ê¸ˆë„ OK)
  Object.keys(reportDraft.sections || {}).forEach(k => {
    if (typeof reportDraft.sections[k] === "string") {
      reportDraft.sections[k] = { text: reportDraft.sections[k], cards: [] };
    }
  });

  bindReportToUI();
  updateReportEditorState(); // âœ… ì¶”ê°€
}


function bindReportToUI() {
  document.getElementById('reportDate').value = reportDraft.reportDate || "";
  document.getElementById('reportTitle').value = reportDraft.title || "";
  document.getElementById('reportOpinion').value = reportDraft.opinion || "";

  ["summary","macro","sector","conclusion"].forEach(sec => {
  const ta = document.getElementById("sec-" + sec);
  ta.value = reportDraft.sections[sec]?.text || "";

  ta.oninput = () => {
    reportDraft.sections[sec]._manualEdited = true;
  };

  renderReportSectionCards(sec);
});

  document.getElementById('reportTickerName').value =
    reportDraft.tickerName || "";

  document.getElementById('reportTickerCode').value =
    reportDraft.tickerCode || "";

  document.getElementById('reportPrice').value =
    reportDraft.price != null ? fmtNum(reportDraft.price) : "";

  renderReportEntries();

  bindAutoResizeToReportTextareas();
}

function removeEntryFromReport(entryId) {
  reportDraft.entries =
    reportDraft.entries.filter(id => id !== entryId);
  renderReportEntries();
}


function renderReportEntries() {
  const box = document.getElementById('reportEntryList');
  if (!box) return;

if (!reportDraft.entries.length) {
  box.innerHTML = `
    <button class="btn btn-ghost"
            style="
              width:100%;
              padding:14px;
              border:1px dashed var(--line);
              background:#f8fafc;
              color:var(--muted);
            "
            onclick="openReportEntryModal()">
      â• ì¹´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
    </button>
  `;
  return;
}
  box.innerHTML = reportDraft.entries.map(id => {
    const e = db.entries.find(x => x.id === id);
    if (!e) return "";

    const seq = getTickerSeq(e);

    return `
      <div class="report-hypothesis">
        <div class="report-hypothesis-title"
     style="cursor:pointer;"
     onclick="jumpToNote(${e.id})">
  ${e.tickerName} (${e.tickerCode}) #${seq}
</div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">
  ${e.date}
</div>


<div style="margin-top:6px;">
  ${e.sector ? `<span class="meta-pill sector">ğŸ· ${escapeHtml(e.sector)}</span>` : ''}
  ${e.tags ? e.tags.split(',').map(t =>
    `<span class="meta-pill tag">#${escapeHtml(t.trim())}</span>`
  ).join('') : ''}
</div>

<div class="report-hypothesis-body" style="white-space:pre-wrap;">
  ${applyHighlight(e.content)}
</div>





${(e.images || []).length ? `
  <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
    ${(e.images || []).map((img, idx) => `
      <img src="${img.src}"
           style="
             width:140px;
             height:90px;
             object-fit:cover;
             border-radius:8px;
             cursor:pointer;
             box-shadow:0 2px 6px rgba(0,0,0,.15);
           "
           onclick="openImg(
             '${img.src.replace(/'/g,"\\'")}',
             '${(img.note||"").replace(/'/g,"\\'")}',
             ${idx},
             ${e.id}
           )">
    `).join("")}
  </div>
` : ''}




${(e.links||[]).length ? `
<div style="margin-top:8px; font-size:11px; border-top:1px dashed var(--line); padding-top:6px;">
  <b style="color:var(--accent);">ğŸ”— ì—°ê²°í•œ ê°€ì„¤</b>
  ${(e.links||[]).map(lid => {
    const t = db.entries.find(x => x.id === lid);
    if (!t) return '';
    return `
      <div class="link-summary" onclick="jumpToNote(${t.id})">
        â†³ ${t.tickerName}(${t.tickerCode}) Â· ${getSummary(t.content)}
      </div>
    `;
  }).join("")}
</div>
` : ''}

${getIncomingLinks(e.id).length ? `
<div style="margin-top:8px; font-size:11px; border-top:1px dashed var(--line); padding-top:6px;">
  <b style="color:#0369a1;">ğŸ” ë‚˜ë¥¼ ì°¸ì¡°í•œ ê°€ì„¤</b>
  ${getIncomingLinks(e.id).map(src => `
    <div class="link-summary"
         style="background:#ecfeff; color:#0369a1;"
         onclick="jumpToNote(${src.id})">
      â†² ${src.tickerName}(${src.tickerCode}) Â· ${getSummary(src.content)}
    </div>
  `).join("")}
</div>
` : ''}

        ${(e.comments && e.comments.length) ? `
  <div style="
    margin-top:6px;
    padding-top:6px;
    border-top:1px dashed var(--line);
    font-size:11px;
    color:var(--muted);
  ">
    <b>ğŸ’¬ ì°¸ê³  ì˜ê²¬</b>
    ${(e.comments || []).slice(-3).map(c => `
      <div style="margin-top:4px;">
        â€¢ ${escapeHtml(c.text)}
      </div>
    `).join("")}
  </div>
` : ''}



        <button class="btn btn-mini btn-ghost"
                onclick="removeEntryFromReport(${id})">âœ•</button>
      </div>
    `;
  }).join('');

box.innerHTML += `
  <button class="btn btn-ghost btn-mini"
          style="margin-top:6px;"
          onclick="openReportEntryModal()">
    â• ì¹´ë“œ ì¶”ê°€
  </button>
`;

}

function saveReport() {
  reportDraft.title =
    document.getElementById('reportTitle').value.trim();
  reportDraft.opinion =
    document.getElementById('reportOpinion').value.trim();
  reportDraft.reportDate =
    document.getElementById('reportDate').value;

  ["summary","macro","sector","conclusion"].forEach(sec => {
    reportDraft.sections[sec].text =
      document.getElementById("sec-" + sec).value;
  });

  reportDraft.price =
    Number(document.getElementById('reportPrice').value.replace(/,/g,'')) || null;

  reportDraft.tickerName =
    document.getElementById('reportTickerName').value.trim();

  reportDraft.tickerCode =
    document.getElementById('reportTickerCode').value.trim();

  reportDraft.updatedAt = Date.now();

  if (editingReportId) {
    db.reports = db.reports.map(r =>
      r.id === editingReportId ? reportDraft : r
    );
  } else {
    db.reports.unshift(reportDraft);
  }

  editingReportId = reportDraft.id;
  persist();
  renderReportList();
  updateSyncStatus();
}


function printReport() {
  window.print();
}


function openReportEntryModal() {
  if (!reportDraft) {
    alert("ë¨¼ì € ì‹ ê·œ ë ˆí¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.");
    return;
  }
  linkingTargetId = "__REPORT__"; // êµ¬ë¶„ì
  document.getElementById('linkSearch').value = "";
  renderLinkOptions("");
  toggleModal('linkModal');
}





function renderReportList() {
  const box = document.getElementById('reportList');
  if (!box) return;

  box.innerHTML = db.reports.map(r => `
    <div class="explorer-item"
         style="position:relative;"
         onclick="openReport(${r.id})">

      <div style="font-weight:900;">
        ${r.title || "(ì œëª© ì—†ìŒ)"}
      </div>

      <div style="font-size:11px; color:var(--muted);">
        ${r.reportDate || ""}
      </div>

      <!-- âŒ ì‚­ì œ ë²„íŠ¼ (ì—¬ê¸°!) -->
      <button class="btn btn-mini btn-ghost"
              style="
                position:absolute;
                top:10px;
                right:10px;
                color:var(--danger);
              "
              onclick="event.stopPropagation(); deleteReport(${r.id})">
        ğŸ—‘
      </button>
    </div>
  `).join('') || `
    <div style="font-size:12px; color:var(--muted);">
      ì €ì¥ëœ ë ˆí¬íŠ¸ ì—†ìŒ
    </div>
  `;


}


function deleteReport(id) {
  if (!confirm("ì´ ë ˆí¬íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  db.reports = db.reports.filter(r => r.id !== id);

  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë ˆí¬íŠ¸ë¼ë©´ ì—ë””í„° ì´ˆê¸°í™”
  if (editingReportId === id) {
    reportDraft = null;
    editingReportId = null;

    document.getElementById('reportTitle').value = "";
    document.getElementById('reportOpinion').value = "";
    document.getElementById('reportDate').value = "";

    document.getElementById('sec-summary').value = "";
    document.getElementById('sec-macro').value = "";
    document.getElementById('sec-sector').value = "";
    document.getElementById('sec-conclusion').value = "";

    document.getElementById('reportEntryList').innerHTML = "";

  updateReportEditorState(); // âœ… ì¶”ê°€
  }

  persist();
  renderReportList();
  updateSyncStatus();
}

function renderReportSelector() {
  const sel = document.getElementById('reportSelector');
  sel.innerHTML =
    `<option value="">ğŸ“„ ë ˆí¬íŠ¸ ì„ íƒ</option>` +
    db.reports.map(r =>
      `<option value="${r.id}">
        ${r.reportDate || "----.--.--"} | ${r.title || "(ì œëª© ì—†ìŒ)"}
      </option>`
    ).join('');
}


async function refreshReportPrice() {
  if (!reportDraft) return;

  const code = document.getElementById('reportTickerCode').value.trim();
  if (!code) return alert("ëŒ€í‘œ ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  const quote = await fetchQuote(code);
  if (!quote) return alert("ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨");

  if (!confirm(`ìë™ ì‹œì„¸ ${fmtNum(quote.price)}ë¡œ ë®ì–´ì“¸ê¹Œìš”?`)) return;

  reportDraft.price = quote.price;

  document.getElementById('reportPrice').value =
    fmtNum(quote.price);

  reportDraft.updatedAt = Date.now();

  persist();
  updateSyncStatus();
}



function openReportSectionEntryModal(section) {
  if (!reportDraft) {
    alert("ë¨¼ì € ì‹ ê·œ ë ˆí¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.");
    return;
  }
  reportTargetSection = section;
  linkingTargetId = "__REPORT_SECTION__";
  document.getElementById('linkSearch').value = "";
  renderLinkOptions("");
  toggleModal('linkModal');
}

function confirmReportSectionLink(targetId) {
  if (!reportDraft || !reportTargetSection) return;

  const sec = reportDraft.sections[reportTargetSection];
  if (!sec.cards.includes(targetId)) {
    sec.cards.push(targetId);

    // ğŸ”¹ ìë™ ë¬¸ë‹¨ ìƒì„±
    autoExpandSectionText(reportTargetSection);

    // ğŸ”¹ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    renderReportSectionCards(reportTargetSection);

    // ğŸ”¹ ğŸ”¥ textarea ì¦‰ì‹œ ë°˜ì˜ (í•µì‹¬)
    const ta = document.getElementById("sec-" + reportTargetSection);
    if (ta) ta.value = sec.text || "";
  autoResizeTextarea(ta); // âœ… ì¶”ê°€
  }

  toggleModal('linkModal');
}

function autoExpandSectionText(section) {
  const sec = reportDraft.sections[section];
  if (sec._manualEdited) return;

  const cards = sec.cards
    .map(id => db.entries.find(e => e.id === id))
    .filter(Boolean);

  sec.text = cards.map(e => {
    return [
      `â€¢ [${e.tickerName}(${e.tickerCode})] ${e.date}`,
      e.content || "(ë³¸ë¬¸ ì—†ìŒ)",
      e.invalidation ? `\n[Risk]\n${e.invalidation}` : ""
    ].join("\n");
  }).join("\n\n---\n\n");
}


function resetReportEditor() {
  if (!reportDraft) return;

  const isNew = !editingReportId;

  if (!confirm(
    isNew
      ? "ì‹ ê·œ ë ˆí¬íŠ¸ ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?"
      : "ì €ì¥ëœ ë ˆí¬íŠ¸ ìƒíƒœë¡œ ë˜ëŒë¦´ê¹Œìš”?"
  )) return;

  if (isNew) {
    newReport();
  } else {
    const r = db.reports.find(x => x.id === editingReportId);
    reportDraft = JSON.parse(JSON.stringify(r));
    bindReportToUI();
    updateReportEditorState(); // âœ… ì¶”ê°€
  }
}


function renderReportSectionCards(section) {
  const box = document.getElementById(section + "CardList");
  if (!box || !reportDraft) return;

  const sec = reportDraft.sections[section];

  box.innerHTML = sec.cards.map(id => {
    const e = db.entries.find(x => x.id === id);
    if (!e) return "";

    // ğŸ“¸ ìº¡ì³ ë¯¸ë¦¬ë³´ê¸°
    const imagesHtml = (e.images || [])
      .slice(0, 2)
      .map(img => `
<img src="${img.src}"
     style="
       width:120px;
       height:80px;
       object-fit:cover;
       border-radius:6px;
       cursor:pointer;
       box-shadow:0 2px 6px rgba(0,0,0,.1);
     "
     onclick="openImg(
       '${img.src.replace(/'/g,"\\'")}',
       '${(img.note||"").replace(/'/g,"\\'")}',
       0,
       ${e.id}
     )">      `).join("");

const commentsHtml = (e.comments || []).length
  ? `
    <div style="
      margin-top:8px;
      padding-top:6px;
      border-top:1px dashed var(--line);
      font-size:11px;
      color:var(--muted);
    ">
      <b>ğŸ’¬ ì°¸ê³  ì˜ê²¬</b>
      ${(e.comments || []).slice(-3).map(c => `
        <div style="margin-top:4px;">
          â€¢ ${escapeHtml(c.text)}
        </div>
      `).join("")}
    </div>
  `
  : "";

    return `
      <div style="
        position:relative;
        border:1px dashed var(--line);
        border-radius:8px;
        padding:10px;
        background:#f8fafc;
        margin-bottom:10px;
      ">

        <!-- âŒ ì‚­ì œ ë²„íŠ¼ -->
        <button class="btn btn-mini btn-ghost"
                style="position:absolute; top:6px; right:6px; color:var(--danger);"
                onclick="removeReportSectionCard('${section}', ${id})">
          âœ•
        </button>

        <div class="link-summary"
             onclick="jumpToNote(${e.id})"


             style="margin-bottom:6px;">
          ${e.tickerName}(${e.tickerCode}) Â· ${e.date}
        </div>




<div style="margin-bottom:6px;">
  ${e.sector ? `<span class="meta-pill sector">ğŸ· ${escapeHtml(e.sector)}</span>` : ''}
  ${e.tags ? e.tags.split(',').map(t =>
    `<span class="meta-pill tag">#${escapeHtml(t.trim())}</span>`
  ).join('') : ''}
</div>


<div style="
  margin:6px 0 8px;
  font-size:12px;
  line-height:1.6;
  color:var(--text);
  white-space:pre-wrap;
">
  ${applyHighlight(getSummary(e.content))}
</div>



        ${imagesHtml
          ? `<div style="display:flex; gap:8px; flex-wrap:wrap;">${imagesHtml}</div>`
          : `<div style="font-size:11px; color:var(--muted);"></div>`
        }

${(e.links||[]).length ? `
<div style="margin-top:8px; font-size:11px; border-top:1px dashed var(--line); padding-top:6px;">
  <b style="color:var(--accent);">ğŸ”— ì—°ê²°í•œ ê°€ì„¤</b>
  ${(e.links||[]).map(lid => {
    const t = db.entries.find(x => x.id === lid);
    if (!t) return '';
    return `
      <div class="link-summary" onclick="jumpToNote(${t.id})">
        â†³ ${t.tickerName}(${t.tickerCode}) Â· ${getSummary(t.content)}
      </div>
    `;
  }).join("")}
</div>
` : ''}

${getIncomingLinks(e.id).length ? `
<div style="margin-top:8px; font-size:11px; border-top:1px dashed var(--line); padding-top:6px;">
  <b style="color:#0369a1;">ğŸ” ë‚˜ë¥¼ ì°¸ì¡°í•œ ê°€ì„¤</b>
  ${getIncomingLinks(e.id).map(src => `
    <div class="link-summary"
         style="background:#ecfeff; color:#0369a1;"
         onclick="jumpToNote(${src.id})">
      â†² ${src.tickerName}(${src.tickerCode}) Â· ${getSummary(src.content)}
    </div>
  `).join("")}
</div>
` : ''}

${commentsHtml}
      </div>
    `;
  }).join("");
}


function removeReportSectionCard(section, entryId) {
  if (!reportDraft) return;

  const sec = reportDraft.sections[section];

  // ì¹´ë“œ ì œê±°
  sec.cards = sec.cards.filter(id => id !== entryId);

  // ğŸ”¹ ë³¸ë¬¸ ìë™ ì¬ìƒì„± (ë¹„ì–´ìˆì„ ë•Œë§Œ)
  sec.text = "";
  autoExpandSectionText(section);

  // ğŸ”¹ textarea ì¦‰ì‹œ ë°˜ì˜
  const ta = document.getElementById("sec-" + section);
  if (ta) ta.value = sec.text || "";

  // ğŸ”¹ ì¹´ë“œ UI ê°±ì‹ 
  renderReportSectionCards(section);
}

function updateReportEditorState() {
  const blank = document.getElementById('reportBlankState');
  const body  = document.getElementById('reportEditorBody');

  if (!reportDraft) {
    blank.style.display = 'block';
    body.style.display = 'none';
  } else {
    blank.style.display = 'none';
    body.style.display = 'block';
  }
}


/* ===============================
   Report textarea ìë™ ë†’ì´ ì¡°ì ˆ
=============================== */

function autoResizeTextarea(el) {
  if (!el) return;

  // ë†’ì´ë¥¼ ì¼ë‹¨ ìµœì†Œë¡œ ì¤„ì˜€ë‹¤ê°€
  el.style.height = "auto";

  // ì‹¤ì œ ë‚´ìš© ë†’ì´ë¡œ ë‹¤ì‹œ ì„¤ì •
  el.style.height = (el.scrollHeight + 2) + "px";
}

/* Report ì—ë””í„° ë‚´ textarea ì „ì²´ì— ì ìš© */
function bindAutoResizeToReportTextareas() {
  const areas = document.querySelectorAll(
    "#reportEditorBody textarea"
  );

  areas.forEach(ta => {
    // ì…ë ¥ ì‹œ ìë™ í™•ì¥
    ta.addEventListener("input", () => autoResizeTextarea(ta));

    // ì´ˆê¸° ë¡œë“œ ì‹œì—ë„ 1íšŒ ì‹¤í–‰
    setTimeout(() => autoResizeTextarea(ta), 0);
  });
}



function getReportsUsingEntry(entryId) {
  if (!db.reports) return [];

  return db.reports.filter(r => {
    // 1ï¸âƒ£ ê·¼ê±° ê°€ì„¤
    if ((r.entries || []).includes(entryId)) return true;

    // 2ï¸âƒ£ ì„¹ì…˜ ì¹´ë“œ
    const secs = r.sections || {};
    return Object.values(secs).some(sec =>
      (sec.cards || []).includes(entryId)
    );
  });
}


function fmtDateTime(ts) {
  if (!ts) return "-";
  const d = new Date(ts);

  // ë‚ ì§œ: YY.MM.DD / ì‹œê°: HH:MM
  const date =
    String(d.getFullYear()).slice(2) + "." +
    (d.getMonth() + 1) + "." +
    d.getDate();

  const time =
    d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  return date + "\n" + time;
}

function removeEntryLink(entryId, targetId) {
  const entry = db.entries.find(e => e.id === entryId);
  if (!entry) return;

  entry.links = (entry.links || []).filter(id => id !== targetId);
  entry.updatedAt = Date.now(); // ğŸ”¥ í•„ìˆ˜

  persist();
  renderAll();
  updateSyncStatus();
}



function getAgeDays(e) {
  const base = e.createdAt || e.updatedAt || 0;
  return Math.floor((Date.now() - base) / 86400000);
}


function getAgeBucket(days) {
  if (days >= 360) return { key: "360", label: "1ë…„+", color:"#7c2d12", bg:"#ffedd5" };
  if (days >= 180) return { key: "180", label: "6ê°œì›”+", color:"#92400e", bg:"#fef3c7" };
  if (days >= 30)  return { key: "30",  label: "1ê°œì›”+", color:"#9a3412", bg:"#fde68a" };
  if (days >= 14)  return { key: "14",  label: "2ì£¼+", color:"#a16207", bg:"#fef3c7" };
  if (days >= 7)   return { key: "7",   label: "1ì£¼+", color:"#0369a1", bg:"#ecfeff" };
  return null;
}


function getReviewGroups() {
  const groups = { "7":[], "14":[], "30":[], "180":[], "360":[] };

  db.entries.forEach(e => {
    const days = getAgeDays(e);
    if (days >= 360) groups["360"].push(e);
    else if (days >= 180) groups["180"].push(e);
    else if (days >= 30) groups["30"].push(e);
    else if (days >= 14) groups["14"].push(e);
    else if (days >= 7) groups["7"].push(e);
  });

  return groups;
}


function renderReviewQueue() {
  const box = document.getElementById("reviewQueue");
  if (!box) return;

  const groups = getReviewGroups();

  const order = ["360","180","30","14","7"];
  const labels = {
    "7":"7ì¼ ì´ìƒ",
    "14":"14ì¼ ì´ìƒ",
    "30":"30ì¼ ì´ìƒ",
    "180":"180ì¼ ì´ìƒ",
    "360":"360ì¼ ì´ìƒ"
  };

  box.innerHTML = order.map(k => {
    if (!groups[k].length) return "";

    return `
      <div style="margin-bottom:10px;">
        <div style="font-size:12px; font-weight:900; color:var(--accent); margin-bottom:4px;">
          â³ ${labels[k]} (${groups[k].length})
        </div>
        ${groups[k].slice(0,10).map(e => `
          <div class="explorer-item"
               onclick="jumpToNote(${e.id})">
            <b>${e.tickerName}(${e.tickerCode})</b>
            <span style="font-size:11px; color:var(--muted); margin-left:6px;">
              ${e.date}
            </span>
            <div style="font-size:12px; margin-top:2px;">
              ${applyHighlight(getSummary(e.content))}
            </div>
<div style="margin-top:4px; display:flex; gap:8px; font-size:11px; color:var(--muted);">
  ${(e.images || []).length ? 'ğŸ“¸ ìº¡ì³' : ''}
  ${(e.links || []).length ? 'ğŸ”— ë§í¬' : ''}
  ${(e.comments || []).length ? 'ğŸ’¬ ëŒ“ê¸€' : ''}
</div>
          </div>
        `).join("")}
      </div>
    `;
  }).join("") || `<div style="font-size:12px; color:var(--muted);">ë¦¬ë·° ëŒ€ìƒ ì—†ìŒ</div>`;
}

function toggleAlarmFields(on){
  document.getElementById('alarmFields')
    .classList.toggle('hidden', !on);
}


function checkAlarms() {
  const today = new Date().toISOString().split('T')[0];

  const due = db.entries.filter(e =>
    e.isAlarm &&
    e.alarm &&
    !e.alarm.done &&
    e.alarm.date &&
    e.alarm.date <= today
  );

  if (!due.length) return;

  alert(
    "ğŸ”” ì˜¤ëŠ˜ í™•ì¸í•  ê°€ì„¤\n\n" +
    due.map(e => `â€¢ ${e.tickerName} (${e.sector || "ì„¹í„° ì—†ìŒ"})`).join('\n')
  );

  due.forEach(e => {
    e.alarm.done = true;
    e.updatedAt = Date.now();
  });

  persist();
renderAll();
updateSyncStatus();
}


function renderAlarmQueue() {
  const box = document.getElementById("alarmQueue");
  if (!box) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  // ğŸ”¹ D-day / D-1 / D-7 ê·¸ë£¹
  const groups = {
    today: [],
    d1: [],
    d7: []
  };

  db.entries.forEach(e => {
    if (
      !e.isAlarm ||
      !e.alarm ||
      e.alarm.done ||
      !e.alarm.date
    ) return;

    const alarmDate = new Date(e.alarm.date);
    alarmDate.setHours(0,0,0,0);

    const diff =
      Math.floor((alarmDate - today) / 86400000);

    if (diff === 0) groups.today.push(e);
    else if (diff === 1) groups.d1.push(e);
    else if (diff > 1 && diff <= 7) groups.d7.push(e);
  });

  const renderGroup = (label, color, list) => {
    if (!list.length) return "";

    return `
      <div style="margin-bottom:14px;">
        <div style="
          font-size:12px;
          font-weight:900;
          color:${color};
          margin-bottom:6px;
        ">
          ${label} (${list.length})
        </div>


${list.map(e => {
  return `
<div class="explorer-item"
     onclick="jumpToNote(${e.id})"
     style="border-left:4px solid ${color};">

  <b>${e.tickerName} (${e.tickerCode})</b>

  ${e.sector ? `<span class="meta-pill sector"
      onclick="event.stopPropagation(); searchByMeta('sector','${e.sector}')"
      style="cursor:pointer;">
  ğŸ· ${e.sector}
</span>` : ''}
  ${e.tags ? e.tags.split(',').map(t =>
    `<span class="meta-pill tag">#${t.trim()}</span>`
  ).join('') : ''}

  <span style="font-size:11px; color:var(--muted); margin-left:6px;">
    ${e.alarm.date}
  </span>

  <div style="font-size:12px; margin-top:4px;">
    ${applyHighlight(getSummary(e.content))}
  </div>

${e.images && e.images.length ? `
<div
  onclick="event.stopPropagation(); openImg(
    '${e.images[0].src.replace(/'/g,"\\'")}',
    '${(e.images[0].note||"").replace(/'/g,"\\'")}',
    0,
    ${e.id}
  )"
  style="
    margin-top:8px;
    display:inline-block;
  ">
  <img src="${e.images[0].src}"
       style="
         width:120px;
         height:80px;
         object-fit:cover;
         border-radius:8px;
         cursor:pointer;
         box-shadow:0 2px 6px rgba(0,0,0,.12);
       ">
</div>
` : ''}

<!-- ğŸ”— ì—°ê²°ëœ ê°€ì„¤ ë¯¸ë¦¬ë³´ê¸° -->
${(e.links || []).length ? `
<div style="
  margin-top:8px;
  font-size:11px;
  padding-top:6px;
  border-top:1px dashed var(--line);
">
  <b style="color:var(--accent);">ğŸ”— ì—°ê²°ëœ ê°€ì„¤</b>
  ${(e.links || []).slice(0,2).map(lid => {
    const t = db.entries.find(x => x.id === lid);
    if (!t) return '';
    return `
      <div class="link-summary"
           style="margin-top:4px;"
           onclick="event.stopPropagation(); jumpToNote(${t.id})">
        â†³ ${t.tickerName}(${t.tickerCode}) Â· ${getSummary(t.content)}
      </div>
    `;
  }).join('')}
</div>
` : ''}

<!-- ğŸ’¬ ëŒ“ê¸€ ë¯¸ë¦¬ë³´ê¸° -->
${(e.comments || []).length ? `
<div style="
  margin-top:8px;
  font-size:11px;
  padding-top:6px;
  border-top:1px dashed var(--line);
">
  <b style="color:var(--muted);">ğŸ’¬ ëŒ“ê¸€</b>
  ${(e.comments || []).slice(-2).map(c => `
    <div style="margin-top:4px;">
      â€¢ ${escapeHtml(c.text)}
    </div>
  `).join('')}
</div>
` : ''}



</div>
`;
}).join("")}

      </div>
    `;
  };

  box.innerHTML =
    renderGroup("ğŸ”¥ D-day (ì˜¤ëŠ˜)", "var(--danger)", groups.today) +
    renderGroup("âš ï¸ D-1 (ë‚´ì¼)", "var(--warning)", groups.d1) +
    renderGroup("ğŸ•’ D-7 (7ì¼ ì´ë‚´)", "var(--accent)", groups.d7)
    || `<div style="font-size:12px; color:var(--muted);">
          ì•ŒëŒ ëŒ€ê¸° ì—†ìŒ
        </div>`;
}


function searchByMeta(type, value) {
  // 1ï¸âƒ£ Explorer íƒ­ìœ¼ë¡œ ì´ë™
  switchTab('explorer');

  // 2ï¸âƒ£ ê²€ìƒ‰ì–´ êµ¬ì„±
  const q =
    type === 'sector'
      ? value
      : value; // íƒœê·¸ë„ ë™ì¼í•˜ê²Œ ë¬¸ìì—´ ê²€ìƒ‰

  // 3ï¸âƒ£ Explorer ê²€ìƒ‰ì°½ì— ì£¼ì…
  const input = document.getElementById('explorerGlobalSearch');
  if (input) {
    input.value = q;
  }

  // 4ï¸âƒ£ ì¦‰ì‹œ ë Œë”
  renderExplorer();
}

function handleDeskSearch(q) {
  deskSearchQuery = (q || "").toLowerCase();

  // ì¢Œì¸¡ íŠ¸ë¦¬ ê°±ì‹ 
  renderTree(q);

  // ìš°ì¸¡ íƒ€ì„ë¼ì¸ ì¦‰ì‹œ ê°±ì‹ 
  renderTimeline();
}

function searchDeskByMeta(value) {
  // Desk íƒ­ ìœ ì§€
  switchTab('desk');

  // ê²€ìƒ‰ì°½ì— ê°’ ì£¼ì…
  const input = document.getElementById('treeSearch');
  if (input) {
    input.value = value;
  }

  // Desk ê²€ìƒ‰ ìƒíƒœ ê°±ì‹ 
  handleDeskSearch(value);
}

function applyHighlight(text) {
  if (!text) return "";

  let t = escapeHtml(text);

  /* -------------------------
     Research Markup (ê¸°ì¡´)
  --------------------------*/
  t = t
    .replace(/\[\[(.*?)\]\]/g,
      `<span class="hl-mark-url">$1</span>`)
    .replace(/\{\{(.*?)\}\}/g,
      `<span class="hl-mark-code">$1</span>`)
    .replace(/==(.*?)==/g,
      `<span class="hl-mark-tag">$1</span>`);

  /* -------------------------
     Markdown Support
  --------------------------*/

  // Headings
  t = t.replace(/^### (.*)$/gm,
      `<div class="md-h3">$1</div>`);
  t = t.replace(/^## (.*)$/gm,
      `<div class="md-h2">$1</div>`);
  t = t.replace(/^# (.*)$/gm,
      `<div class="md-h1">$1</div>`);

// Bold ë¨¼ì €
t = t.replace(/\*\*(.*?)\*\*/g,
    `<span class="md-bold">$1</span>`);

// Underline
t = t.replace(/__(.*?)__/g,
    `<span class="md-underline">$1</span>`);

// Italic (ë‹¨ì¼ ë³„í‘œë§Œ)
t = t.replace(/(^|[^*])\*(?!\*)(.*?)\*(?!\*)/g,
    `$1<span class="md-italic">$2</span>`);

  // Blockquote
  t = t.replace(/^&gt; (.*)$/gm,
      `<div class="md-quote">$1</div>`);

  // Horizontal Rule
  t = t.replace(/^---$/gm,
      `<div class="md-hr"></div>`);

  // Unordered List
  t = t.replace(/^- (.*)$/gm,
      `<div class="md-li">$1</div>`);

  return t;
}


function filterReport() {

  const keyword =
    document.getElementById('reportSearch')
      ?.value.toLowerCase() || "";

  const items =
    document.querySelectorAll('#reportList .explorer-item');

  items.forEach(item => {

    const text = item.innerText.toLowerCase();

    item.style.display =
      text.includes(keyword) ? "" : "none";

  });

}




</script>
</body>
</html>